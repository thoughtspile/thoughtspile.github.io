<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    
      <meta name="google-site-verification" content="5nfOA5k_QcuAP9zbAASIV24DlAZG7BWxRVYoNlKCAoc" />
    
    <meta name="description" content="It’s no secret that react’s useCallback is just sugar on top of useMemo that saves the children from having to see an arrow chain. As the docs go: 123useCallback((e) =&amp;gt; onChange(id, e.target.value)">
<meta name="keywords" content="programming,frontend,react,hooks">
<meta property="og:type" content="article">
<meta property="og:title" content="How useRef turned out to be useMemo&#39;s father">
<meta property="og:url" content="https://thoughtspile.github.io/2021/04/05/useref-usememo/index.html">
<meta property="og:site_name" content="Vladimir Klepov as a Coder">
<meta property="og:description" content="It’s no secret that react’s useCallback is just sugar on top of useMemo that saves the children from having to see an arrow chain. As the docs go: 123useCallback((e) =&amp;gt; onChange(id, e.target.value)">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://thoughtspile.github.io/images/hook-vader.jpg">
<meta property="og:updated_time" content="2021-04-09T18:09:05.666Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How useRef turned out to be useMemo&#39;s father">
<meta name="twitter:description" content="It’s no secret that react’s useCallback is just sugar on top of useMemo that saves the children from having to see an arrow chain. As the docs go: 123useCallback((e) =&amp;gt; onChange(id, e.target.value)">
<meta name="twitter:image" content="https://thoughtspile.github.io/images/hook-vader.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>How useRef turned out to be useMemo&#39;s father</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Vladimir Klepov as a Coder" type="application/atom+xml" />
    

    <script type='text/javascript' src='//platform-api.sharethis.com/js/sharethis.js#property=5c1957fa423bba0012ec3bd1&product=inline-share-buttons'
      async='async'></script>

</head>

<body class="max-width mx-auto px3">
    <div class="content index my4">
        <a href="/" id="header" class="header header--post">
  
    
    <div id="logo" style="background-image: url(/images/logo.png);"></div>
  
  <header id="title">
    <h1>Vladimir Klepov as a Coder</h1>
  </header>
</a>

        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        How useRef turned out to be useMemo&#39;s father
    </h1>



    <div class="meta">
      
    <div class="postdate">
        <time datetime="2021-04-05T15:59:25.000Z" itemprop="datePublished">05.04.2021</time>
    </div>


      
    <div class="article-tag">
        <a class="tag-link" href="/tags/frontend/">frontend</a>, <a class="tag-link" href="/tags/hooks/">hooks</a>, <a class="tag-link" href="/tags/programming/">programming</a>, <a class="tag-link" href="/tags/react/">react</a>
    </div>


    </div>
  </header>
  <div class="content" itemprop="articleBody">
    <p>It’s no secret that react’s <code>useCallback</code> is just sugar on top of <code>useMemo</code> that saves the children from having to see an arrow chain. As <a href="https://reactjs.org/docs/hooks-reference.html" target="_blank">the docs</a> go:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useCallback(<span class="function">(<span class="params">e</span>) =&gt;</span> onChange(id, e.target.value), [onChange, id]);</span><br><span class="line"><span class="comment">// is equivalent to</span></span><br><span class="line">useMemo(<span class="function"><span class="params">()</span> =&gt;</span> (e) =&gt; onChange(id, e.target.value), [onChange, id]);</span><br></pre></td></tr></table></figure>
<p><img src="/images/hook-vader.jpg" alt=""></p>
<blockquote>
<p>A less known, probably useless, but very fun, fact: you can actually pass something other than a function to <code>useCallback</code> and have it memoized.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> stableValue = useCallback(&#123; <span class="attr">please</span>: <span class="string">'dont do this'</span> &#125;, []);</span><br><span class="line"><span class="comment">// yes-yes, stableValue is that object, as of react@17.0.2</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>As I got more into hooks, I’ve been surprised to realize how similar <code>useMemo</code> itself is to <code>useRef</code>. Think about it that way: <code>useRef</code> does a very simple thing — persists a value between render function calls and lets you update it as you wish. <code>useMemo</code> just provides some automation on top for updating this value when needed. Recreating <code>useMemo</code> is fairly straightforward:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> memoRef = useRef();</span><br><span class="line"><span class="keyword">const</span> lastDeps = useRef(deps);</span><br><span class="line"><span class="comment">// some shallow array comparator, beside the point</span></span><br><span class="line"><span class="keyword">if</span> (!arrayEquals(deps, lastDeps.current)) &#123;</span><br><span class="line">    memoRef.current = factory();</span><br><span class="line">    lastDeps.current = deps;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> memoized = memoRef.current;</span><br><span class="line"><span class="comment">// ... is equivalent to const memoized = useMemo(factory, deps);</span></span><br></pre></td></tr></table></figure>
<p>As a special case, raw <code>useRef</code> is <em>almost</em> the same as <code>useMemo</code> with no deps, save for actually building the initial value on every render and then throwing it away:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> stableData = useRef(&#123;&#125;).current; <span class="comment">// same as useMemo(() =&gt; &#123;&#125;, []);</span></span><br></pre></td></tr></table></figure>
<p>Treating <code>useRef</code> as a stripped-down <code>useMemo</code> can prove useful in some cases. If the built-in caching mechanism does not work for you, <code>useRef</code> is a perfect way to tweak it. Some motivational examples:</p>
<ul>
<li>Actually cache all the previous results using eg <a href="https://github.com/caiogondim/fast-memoize.js" target="_blank">fast-memoize.</a> <code>useMemo</code> appears to just cache the last result, which is a good default.</li>
<li>Support true array dependencies with dynamic length: <code>useArrayMemo(() =&gt; hash(arrayValues), arrayValues)</code></li>
<li>Use an object instead of an array: <code>useObjectMemo(() =&gt; props, props)</code> gives you the same reference unless a prop has changed.</li>
<li>More generally, allow any custom comparator for deps: <code>useCustomMemo(() =&gt; lib.sum(table1, table2), [table1, table2], (a, b) =&gt; a.equals(b))</code></li>
</ul>
<p>These may not be the most common use cases, but it’s good to know that this is doable, and that <code>useRef</code> is there to help you in case you ever need it.</p>
<blockquote>
<p>On to another fun fact — you can make <code>useMemo</code> return a constant-reference <code>RefObject</code> box, equivalent to <code>useRef</code>. It’s not clear why you would want that.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useMemo(<span class="function"><span class="params">()</span> =&gt;</span> (&#123; <span class="attr">current</span>: initialValue &#125;), [])</span><br></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<p>So, wrapping up:</p>
<ol>
<li><code>useCallback</code> is just tiny sugar on top of <code>useMemo</code>.</li>
<li><code>useMemo</code> is just <code>useRef</code> with auto-update functionality.</li>
<li>You can build customized versions of <code>useMemo</code> with <code>useRef</code>.</li>
<li>You <em>can</em> bend <code>useCallback</code> to be a <code>useMemo</code>, and you can get <code>useMemo</code> to be a <code>useRef</code>, but that doesn’t mean you <em>should.</em></li>
</ol>
<p>On the other hand, <code>useState</code> (and <code>useReducer</code>) is an entirely different cup of tea, since they can trigger a rerender on update. More on these guys in the next post!</p>

  </div>
  <div class="call-to-action clearfix">
    
      <a class="call-to-action__item left" href="/2021/04/02/promise-timeout/">
        <i class="fas fa-chevron-left fa-3x"></i>
        <span class="call-to-action__item__name">How to timeout a promise</span>
      </a>
    
    
      <a class="call-to-action__item right" href="/2021/04/07/better-usecallback/">
        <span class="call-to-action__item__name">Did I just build a better useCallback?</span>
        <i class="fas fa-chevron-right fa-3x"></i>
      </a>
    
  </div>
</article>
<div class="sharethis-inline-share-buttons"></div>



    </div>
    <footer id="footer">
  <a href="/">
    A blog by Vladimir Klepov
  </a>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-121445688-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->



<!DOCTYPE html><!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1"
    />
    <meta name="yandex-verification" content="635edef3908320be" />
    <meta
      name="google-site-verification"
      content="1-m0w7Up8df1sn0230jxfTKKZ4jLeln_Em1tcyfU0qw"
    />
    <title>Thanks React, I&#39;m fine with an imperative setInterval</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link
      rel="canonical"
      href="https://blog.thoughtspile.tech/2021/10/13/really-declarative/"
    />
    <link
      rel="alternate"
      href="/atom.xml"
      title="Vladimir Klepov as a Coder"
      type="application/atom+xml"
    />
  </head>
  <body class="max-width mx-auto px3">
    <div class="content index">
      <a href="/" id="header" class="header header--post"
        ><div id="logo"></div>
        <header id="title">
          <h1>Thanks React, I&#39;m fine with an imperative setInterval</h1>
        </header></a
      >
      <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
        <header><h1 class="posttitle" itemprop="name headline"></h1></header>
        <div class="content" itemprop="articleBody">
          <p>
            Like many of you, I've read Dan Abramov's excellent article,
            <a
              href="https://overreacted.io/making-setinterval-declarative-with-react-hooks"
              target="_blank"
              rel="noopener"
              >making setInterval declarative with React hooks.</a
            >
            It's a great introduction to hook thinking and gotchas, highly
            recommended to any react dev. But by now the insistence on being
            declarative in every hook ever has gone too far, and it's starting
            to annoy me. Hook libraries that don't expose imperative handles at
            all are less useful, and using them comes with a real performance
            cost. How so? Let me show.
          </p>
          <p><img src="/images/set-timeout.jpg" alt="" /></p>
          <h2>The example</h2>
          <p>
            Let's jump straight into the code. I'm building a synthetic input
            with a nice &quot;info&quot; icon that explains what this input is
            for when the user hovers it. To prevent any jumpiness when the user
            just moves the mouse around, I open the tooltip after 100ms of
            hovering:
          </p>
          <pre
            class="language-jsx"
          ><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Input</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> details <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>showDetails<span class="token punctuation">,</span> setShowDetails<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>isHovered<span class="token punctuation">,</span> setHovered<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">useTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">setShowDetails</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> isHovered <span class="token operator">?</span> <span class="token number">100</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">onEnter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setHovered</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">onLeave</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">setHovered</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">setShowDeatils</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token punctuation">/></span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><br>        <span class="token attr-name">onMouseEnter</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onEnter<span class="token punctuation">}</span></span><br>        <span class="token attr-name">onMouseLeave</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onLeave<span class="token punctuation">}</span></span><br>      <span class="token punctuation">></span></span><span class="token plain-text">i</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
          <p>
            And here's the <code>useTimeout</code> hook — I'll skip the part
            where Dan explains why this code looks what it looks like, please
            check out his
            <a
              href="https://overreacted.io/making-setinterval-declarative-with-react-hooks"
              target="_blank"
              rel="noopener"
              >original post</a
            >
            if you have any questions. I only replaced the interval with a
            timeout, because, to tell you the truth, I have used intervals
            exactly zero times in the past 5 years, but I use timeouts every
            week.
          </p>
          <pre
            class="language-jsx"
          ><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">useTimeout</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> savedCallback <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Remember the latest callback.</span><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    savedCallback<span class="token punctuation">.</span>current <span class="token operator">=</span> callback<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Set up the interval.</span><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        savedCallback<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>delay<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
          <p>
            It's a nice, consistent hook that does many things right — in fact,
            it's similar to my idea of
            <a href="/2021/04/07/better-usecallback/"
              >the perfect useCallback.</a
            >
            Let's first admire the things it does right:
          </p>
          <ul>
            <li>You can't forget to clear the timeout on unmount.</li>
            <li>You never call a stale callback.</li>
            <li>
              You don't even have to specify callback &quot;dependencies&quot;
            </li>
          </ul>
          <p>
            But then there's something I don't like that much. To set a
            callback, we switch the <code>hovered</code> state. This state
            change triggers the effect in <code>useTimeout</code> that actually
            sets the timeout. <em>But,</em> like every state change, it also
            happens to re-render a component. So, while we're calling our
            <code>setTimeout</code>, we also get to:
          </p>
          <ol>
            <li>Call setState</li>
            <li>Schedule a re-render</li>
            <li>Call the render function</li>
            <li>Produce a bunch of objects and functions for our hooks</li>
            <li>Compare some dependency arrays</li>
            <li>
              Note that <code>hovered</code> has changed, and schedule that
              effect from <code>useTimeout</code>
            </li>
            <li>Generate a bunch of vDOM</li>
            <li>
              Diff the old and new vDOMs to see that almost nothing happened
            </li>
            <li>
              Bind new DOM event handlers, because their reference has changed,
              who knows
            </li>
            <li>Finally, <code>setTimeout</code>!</li>
          </ol>
          <p>
            I mean, it will all probably happen pretty fast, but come on, is
            calling a <code>setTimeout</code> <em>really</em> worth all that
            fuss? Me, I don't think so. The idea of making my user's CPU go
            through all that hoops to call a function makes me very sad.
            Luckily, I know how to fix it.
          </p>
          <h2>Give me back my imperative</h2>
          <p>
            What if we were to skip the <em>declarative</em> part, and just
            tried to build a consistent hook wrapper around
            <code>setTimeout</code>? Here's my take (we use a
            <a
              href="https://github.com/VKCOM/VKUI/blob/288114403c892ae11e60fe65525cdef89a272c53/src/hooks/useTimeout.ts"
              target="_blank"
              rel="noopener"
              >very similar hook</a
            >
            in our production code):
          </p>
          <pre
            class="language-jsx"
          ><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">useImperativeTimeout</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> timeoutId <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> savedCallback <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Remember the latest callback.</span><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    savedCallback<span class="token punctuation">.</span>current <span class="token operator">=</span> callback<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// this handle clears the timeout</span><br>  <span class="token keyword">const</span> clear <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutId<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// this handle sets our timeout</span><br>  <span class="token keyword">const</span> set <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// but clears the old one first</span><br>    <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    timeoutId<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      savedCallback<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>delay<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// also, clear the timeout on unmount</span><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> clear<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">{</span> set<span class="token punctuation">,</span> clear <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
          <p>
            We can finally call <code>timeout.set()</code> and just have it
            <code>setTimeout</code> for us and do nothing else. I've left the
            original <code>savedCallback</code> logic intact, nothing wrong with
            it.
          </p>
          <blockquote>
            <p>
              The hook behavior in some corner cases has changed. If I set the
              timeout to 300ms, and then 200ms later change the delay to 50ms,
              should it fire in 300 – 200 = 100ms, as originally intended (my
              behavior)? 50ms from now (Dan's behavior)? 50 – 200 = 150ms ago
              (haha, that's very correct but you can't do that)? RIGHT NOW if
              we're already past deadline? Who knows. All options are fine for
              such a weird case as long as it doesn't explode.
            </p>
          </blockquote>
          <p>
            But now our <code>Input</code> has to wrangle with the nasty
            <em>imperatives,</em> and it probably looks awful. Not at all:
          </p>
          <pre
            class="language-jsx"
          ><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Input</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> details <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>showDetails<span class="token punctuation">,</span> setShowDetails<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> showTimeout <span class="token operator">=</span> <span class="token function">useImperativeTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">setShowDetails</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> onEnter <span class="token operator">=</span> showTimeout<span class="token punctuation">.</span>set<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">onLeave</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    showTimeout<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">setShowDeatils</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token punctuation">/></span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><br>        <span class="token attr-name">onMouseEnter</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onEnter<span class="token punctuation">}</span></span><br>        <span class="token attr-name">onMouseLeave</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onLeave<span class="token punctuation">}</span></span><br>      <span class="token punctuation">></span></span><span class="token plain-text">i</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
          <p>
            In fact, we've not only eliminated the extra render, but also
            removed the <code>hovered</code> state whose only job was to toggle
            the timeout. I'd say good old imperatives just scored a goal.
          </p>
          <h2>Were we imperative all along?</h2>
          <p>
            Upon closer inspection, our initial
            <em>&quot;declarative&quot;</em> <code>useTimeout</code> is not that
            declarative. Take note:
          </p>
          <ul>
            <li><code>onMouseOver</code> event handler is imperative,</li>
            <li>
              <code>setHovered</code> is imperative — even grammatically, I
              sometimes say &quot;come on React, <em>set hovered</em> to
              true&quot;,
            </li>
            <li><code>setTimeout</code> is imperative, too.</li>
          </ul>
          <p>
            We're basically converting these imperative things into the
            declarative world, then back again.
          </p>
          <p>
            Moreover, the mental model is slightly broken — while
            <code>hovered</code> flag supposedly means &quot;timeout is
            running&quot;, it may not be the case. The timeout is either running
            or has already fired. But maybe that's just me being tedious.
          </p>
          <h2>What declarative can't do</h2>
          <p>
            Now suppose I want to implement a debounce with the
            <em>declarative useTimeout.</em> I want to track my user's mouse
            motion, and show a popup once he stops moving. For that, I normally
            set a small timeout to show the popup — 30ms will do — on
            <code>mousemove</code>. If the user moves the mouse again within the
            next 30ms, well, I set another timeout and try again. If the mouse
            stops, the timeout successfully fires, and the popup appears. Really
            simple (no React yet):
          </p>
          <pre
            class="language-jsx"
          ><code class="language-jsx"><span class="token keyword">let</span> popupTimeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>img<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">clearTimeout</span><span class="token punctuation">(</span>popupTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  popupTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>showPopup<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
          <p>
            But the only way to set our <em>decalrative useTimeout</em> is
            passing a non-null delay. How would you do this with our declarative
            timeout?
          </p>
          <pre
            class="language-jsx"
          ><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Img</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> title<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>hasPopup<span class="token punctuation">,</span> setPopup<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">useTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setPopup</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">??</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> onMove <span class="token operator">=</span> <span class="token operator">??</span><br>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">onMouseMove</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onMove<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text"><br>    </span><span class="token punctuation">{</span>hasPopup <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">}</span><span class="token plain-text"><br>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
          <p>
            You could move the delay a little bit, like 30 -&gt; 31 -&gt; 30, or
            dance around with 30 -&gt; null -&gt; 30, but that's just dirty. In
            any case, <code>mousemove</code> is absolutely not the event you'd
            want to re-render on.
          </p>
          <p>Imperative timeout to the rescue:</p>
          <pre
            class="language-jsx"
          ><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Img</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> title<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>hasPopup<span class="token punctuation">,</span> setPopup<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> popupTimeout <span class="token operator">=</span> <span class="token function">useImperativeTimeout</span><span class="token punctuation">(</span><br>    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setPopup</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> onMove <span class="token operator">=</span> popupTimeout<span class="token punctuation">.</span>set<span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">onMouseMove</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onMove<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text"><br>    </span><span class="token punctuation">{</span>hasPopup <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">}</span><span class="token plain-text"><br>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
          <p>It works, it's fast, it's simple. 2:0 in favor of old school!</p>
          <h2>How we can have it all</h2>
          <p>
            Before you point this out to me, I'd love to quote the original
            article's disclaimer myself:
            <em
              >This post focuses on a pathological case. Even if an API
              simplifies a hundred use cases, the discussion will always focus
              on the one that got harder.</em
            >
            I'll be the first to admit I'm now exploring a pathological case of
            a pathological case. Know why? Because that's the kind of stuff I
            enjoy.
          </p>
          <p>
            Problem is, the fully declarative API most hooks offer is on a
            higher level of abstraction than imperative handles. JS culture of
            making lower-lever building blocks inaccessible to the library users
            has bothered me for a long time (ouch, I still remember that time I
            copy-pasted react-router source to modify link actions for an
            electron app). But I think this culture has probably peaked in
            hooks.
          </p>
          <p>Declarative timeout is very convenient in many cases:</p>
          <ul>
            <li>
              If many different things can set a timeout — like maybe a
              <code>mousedown</code>, but also a <code>keydown</code> —
              separating cause and effect with an intermediate state works
              great.
            </li>
            <li>
              If you're going to use the state for other things, you still need
              to re-render, so there's no <em>wasted</em> render.
            </li>
          </ul>
          <p>
            But, as we've seen, it makes some other cases impossibly difficult,
            and can introduce wasted renders.
          </p>
          <p>
            What if we could have the best of both worlds — provide a nice
            declarative API for 90% use cases, and also an imperative one to
            please old grumpy people like me? Yes we can:
          </p>
          <pre
            class="language-jsx"
          ><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">useWrapTimeout</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> handle <span class="token operator">=</span> <span class="token function">useImperativeTimeout</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      handle<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">return</span> handle<span class="token punctuation">.</span>clear<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>delay<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
          <p>
            This is what you think it is — the declarative timeout, built on top
            of our imperative timeout. Works absolutely the same. We could even
            expose <em>both</em> APIs from a single hook (just
            <code>return handle</code>), but the interaction between the
            declarative state and imperative overrides is not pleasant. On the
            other hand, declarative timeout can't be used to build an imperative
            timeout, period.
          </p>
          <hr />
          <p>A traditional recap:</p>
          <ul>
            <li>
              Hooks without an imperative API make re-rendering the only way to
              communicate with the hook, which is wasteful.
            </li>
            <li>
              Re-rendering a component and checking if some variable has changed
              since last render <em>is</em> a convoluted way to call a function.
            </li>
            <li>
              Communicating between imperative actions (event -&gt; setTimeout
              call) through a declarative value is not always possible.
            </li>
            <li>
              Imperative APIs can be harder to work with, but are also more
              flexible.
            </li>
            <li>
              You can build declarative APIs on top of imperative ones, but not
              the other way around.
            </li>
          </ul>
          <p>
            Dear library authors, please do expose lower-level APIs. Don't make
            me copy-paste your code to do things a little differently from the
            95% use case.
          </p>
          <p>
            Want to learn more about pathological cases in React hooks?
            <a href="/tags/hooks/">I have a lot of that.</a> See you around!
          </p>
        </div>
        <span class="share"
          ><div>
            <a
              href="https://twitter.com/share?url=&text= by @thoughtspile"
              target="_blank"
              rel="noopener"
              >Tweet</a
            >
          </div>
          <div id="share-button"><a>Share</a></div>
          <div>
            <a
              href="https://twitter.com/search?q=https://blog.thoughtspile.tech/2021/10/13/really-declarative/"
              target="_blank"
              rel="noopener"
              >Discuss on Twitter</a
            >
          </div></span
        >
        <div class="post-related">
          More? <a class="tag-link-link" href="/">All posts ever</a>
          <a class="tag-link-link" href="/tags/react" rel="tag">react</a>
          <a class="tag-link-link" href="/tags/hooks" rel="tag">hooks</a>
          <a class="tag-link-link" href="/tags/javascript" rel="tag"
            >javascript</a
          >
          <a class="tag-link-link" href="/tags/frontend" rel="tag">frontend</a>
        </div>
        <div class="post-actions">
          Written in <time>2021</time> by&nbsp;your friend,
          <a href="/">Vladimir.</a> Follow&nbsp;me on&nbsp;<a
            href="https://twitter.com/thoughtspile"
            target="_blank"
            rel="noopener"
            >Twitter</a
          >
          to&nbsp;get post updates. I&nbsp;have
          <a href="/atom.xml">RSS,</a> too. And you can
          <a
            class="bmc link--bare"
            href="https://buymeacoffee.com/thoughtspile"
            target="_blank"
            rel="noopener"
            >buy me a coffee!</a
          >
        </div>
        <div class="post-siblings">
          <a class="link--bare" href="/2021/10/11/usestate-object-vs-multiple/"
            ><div class="post-siblings__direction">Older</div>
            <span class="link__text"
              >Are many useStates better than useState(object)?</span
            > </a
          ><a class="link--bare" href="/2021/10/18/non-react-state/"
            ><div class="post-siblings__direction">Newer</div>
            <span class="link__text"
              >How to replace useState with useRef and be a winner</span
            ></a
          >
        </div>
      </article>
    </div>
  </body>
</html>
<script type="text/javascript">
  (function (i, s, o, g, r, a, m) {
    i["GoogleAnalyticsObject"] = r;
    (i[r] =
      i[r] ||
      function () {
        (i[r].q = i[r].q || []).push(arguments);
      }),
      (i[r].l = 1 * new Date());
    (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m);
  })(
    window,
    document,
    "script",
    "//www.google-analytics.com/analytics.js",
    "ga"
  );
  ga("create", "UA-121445688-1", "auto");
  ga("send", "pageview");
</script>
<script src="/js/share.js"></script>

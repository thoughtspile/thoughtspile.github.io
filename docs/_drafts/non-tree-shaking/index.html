<!DOCTYPE html><p>Tree shaking is an optimization technique commonly used to reduce bundle size. https://webpack.js.org/guides/tree-shaking/</p><p>The recurring theme is that <em>objects</em> are not very good at tree-shaking. When the bundler sees that you declare</p><h2>Intro: why objects are bad for tree-shaking</h2><p>Another minification concern (unrelated to tree shaking) is that mangling object property names is quite hard. If you have a variable with a <code>longButVeryDescriptiveName</code>, you can trivially rename it to <code>l</code> and replace every reference to it with <code>l</code>, because in runtime you can't access a varibale name anyways (unless you use <code>eval</code>. <code>eval</code> is evil). But to mangle object property names, you have to:</p><ul><li>Replace property names in literals, eg <code>{ long: 9 } -&gt; { p: 9 }</code></li><li>Now traverse the entire codebase, find every reference to the object and replace property names, e.g. <code>obj.long -&gt; obj.p</code> (remember that the object can be assigned to variables, put into other objects and so on)</li><li>Properties with the same name must be shortened the same way in case you pass them into functions (as in<code>[fn(obj1), fn(obj2)]</code>), or do <code>{ ...object, ...merging }</code>.</li><li>Now our optiization is <em>busted</em> if you convert objects to and from JSON, use <code>Object.keys/values/entries</code> or <code>for..in</code> or <code>'key' in obj</code>, or even just a simple dynamic access as in <code>obj[prop]</code>. The task gets <em>unreasonably</em> hard.</li></ul><p>At any rate, this results in a bunch of useless repeating strings across your codebase, not a deal breaker compared to pulling that 100K library.</p><h2>Object exports</h2><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> moneyUtils <span class="token operator">=</span> <span class="token punctuation">{</span><br>  applyVat<span class="token punctuation">,</span><br>  convertCurrency<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> moneyUtils <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'moneyUtils'</span><span class="token punctuation">;</span><br><br>moneyUtils<span class="token punctuation">.</span><span class="token function">convertCurrency</span><span class="token punctuation">(</span>sum<span class="token punctuation">,</span> <span class="token string">'USD'</span><span class="token punctuation">,</span> <span class="token string">'EUR'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The simple fix here is just to avoid putting independent helpers into an object:</p><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token punctuation">{</span> applyVat<span class="token punctuation">,</span> convertCurrency <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>This ensures that helpers not used anywhere in the project do not end up in the bundle.</p><p>When it comes to chunking,</p><h2>TS enums</h2><h2>Classes</h2><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Money</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">amount<span class="token punctuation">,</span> currency</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><br>  <span class="token function">toCurrency</span><span class="token punctuation">(</span><span class="token parameter">newCurrency</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><br>  <span class="token function">applyVat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">new</span> <span class="token class-name">Money</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'USD'</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">toCurrency</span><span class="token punctuation">(</span><span class="token string">'EUR'</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">applyVat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Money</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">amount<span class="token punctuation">,</span> currency</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><span class="token keyword">const</span> <span class="token function-variable function">toCurrency</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">money<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token function-variable function">applyVat</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">money</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> total <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Money</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'USD'</span><span class="token punctuation">)</span><br><span class="token function">applyVat</span><span class="token punctuation">(</span><span class="token function">toCurrency</span><span class="token punctuation">(</span>total<span class="token punctuation">,</span> <span class="token string">'EUR'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>https://ncjamieson.com/understanding-lettable-operators/#using-prototype-patching</p><pre class="language-js"><code class="language-js"><span class="token comment">// in applyVat.js</span><br><span class="token class-name">Money</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>applyVat <span class="token operator">=</span> applyVat<span class="token punctuation">;</span></code></pre><h2>Function properties</h2><p>For another twist on the same topic, let's try</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br>sum<span class="token punctuation">.</span><span class="token function-variable function">arrays</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">arr1</span><span class="token punctuation">)</span> <span class="token operator">=></span> arr1<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>sum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Now the same, but in React:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Input</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br>Input<span class="token punctuation">.</span><span class="token function-variable function">masked</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> mask<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> maskProps <span class="token operator">=</span> <span class="token function">useFancyMask</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>maskProps<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>While this allows you to write convenient things like <code>&lt;Input.masked /&gt;</code>, this also means that a plain <code>&lt;Input /&gt;</code> pulls all the mask-related code. In react case, this is almost impossible to avoid, as the code compiles to <code>createElement(Input)</code>, and for all compiler knows <code>createElement</code> might use <code>.masked</code> internally. Game over.</p><h2>Facades</h2><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">PlainInput</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token keyword">function</span> <span class="token function">MaskedInput</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> mask<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> maskProps <span class="token operator">=</span> <span class="token function">useFancyMask</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">PlainInput</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>maskProps<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><br><span class="token punctuation">}</span><br><span class="token keyword">function</span> <span class="token function">Input</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> props<span class="token punctuation">.</span>mask <br>    <span class="token operator">?</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">MaskedInput</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span> <br>    <span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">PlainInput</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2>Default parameters</h2><p>Maybe we can saver the day with default parameters?</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Input</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> useMask <span class="token operator">=</span> useFancyMask<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> maskProps <span class="token operator">=</span> <span class="token function">useMask</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>PlainInput <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>maskProps<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Now if we use <code>&lt;Input useMask={() =&gt; ({})} /&gt;</code> our empty <code>useMask</code> will override <code>useFancyMask</code>, so it can be safely removed</p><p>https://github.com/floating-ui/react-popper/blob/master/src/usePopper.js https://github.com/floating-ui/react-popper/issues/380</p><hr>
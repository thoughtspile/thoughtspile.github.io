<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="yandex-verification" content="635edef3908320be"><meta name="google-site-verification" content="1-m0w7Up8df1sn0230jxfTKKZ4jLeln_Em1tcyfU0qw"><meta name="color-scheme" content="dark light"><meta property="og:type" content="article"><meta property="og:title" content="Advanced Promise Coordination: Rate Limiting"><meta property="og:url" content="https://blog.thoughtspile.tech/2018/07/07/rate-limit-promises/"><meta property="og:site_name" content="Vladimir Klepov as a Coder"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.thoughtspile.tech/images/bmc.png"><meta property="article:published_time" content="2018-07-07T00:00:00.000Z"><meta property="article:author" content="Vladimir Klepov"><meta property="article:tag" content="promises"><meta property="article:tag" content="javascript"><meta property="article:tag" content="programming"><meta property="article:tag" content="high availability"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@thoughtspile"><meta name="twitter:image" content="https://blog.thoughtspile.tech/images/bmc.png"><title>Advanced Promise Coordination: Rate Limiting</title><link rel="stylesheet" href="/css/style.css?ts=1675547910302"><link rel="canonical" href="https://blog.thoughtspile.tech/2018/07/07/rate-limit-promises/"><link rel="alternate" href="/atom.xml" title="Vladimir Klepov as a Coder" type="application/atom+xml"><script defer="defer" data-domain="blog.thoughtspile.tech" src="https://t.thoughtspile.tech/js/script.js"></script></head><body class="max-width mx-auto px3"><div class="content index"><a href="/" id="header" class="header header--post"><div id="logo"></div><header id="title"><h1>Vladimir Klepov as a Coder</h1></header></a><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Advanced Promise Coordination: Rate Limiting</h1><div class="post__date">Written in <time>2018</time></div></header><div class="content" itemprop="articleBody"><p>In the <a href="/2018/06/20/serialize-promises/">previous post</a> we learnt to serialize and concurrecy-limit promise-based operations in js. This time we dive further and handle rate limiting.</p><h2>What Exactly to Rate Limit</h2><p>Let's get terminological matters out of the way first. Promises represent operations that last a certain amount of time, while rate limiting is applied to discrete events. Over its life, a promise starts and terminates (with a success or a failure, not important now). It makes most sense to rate limit promise creations (starts). Rate limiting promise resolutions can be done by appending a start-rate-limited promise onto the end of the running promise. We could also limit the gap between operations, but I have no idea how that would be useful.</p><h2>Rate vs concurrency limiting</h2><p>While both rate and concurrency limits are trying to prevent a client from overloading the server by making too many calls too fast, they do not replace one another, and are implemented differently.</p><p>Suppose an API is rate-limited to 1 request per second. Even 1-concurrent requests break the rate limit if they complete in under 1s. On the other hand, if the requests take 3 seconds to complete, we can only have 3 of them running at the same time:</p><pre><code>...
 ...
  ...
</code></pre><p>We could derive a bunch of formulae to connect the concurrency, rate and running time of operations, but that's completely beside the point. The thing to remember here is that without strict guarantees on operation duration you can not replace concurrency limit with rate limit or vice versa.</p><h2>Rate limiting individual operations</h2><p>The simplest form of rate limiting is &quot;1 operation per N seconds&quot;. This one is straightforward, but first we need a building block — the promise counterpart of <code>setTimeout</code>:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">resolveAfter</span> <span class="token operator">=</span> <span class="token parameter">ms</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">ok</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>ok<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>resolveAfter</code> is self-explanatory: it returns a promise that resolves after the specified time has elapsed. Now, for the actual rate limiter:</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">rateLimit1</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> msPerOp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> wait <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>a</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// We use the queue tail in wait to start both the</span><br>    <span class="token comment">// next operation and the next delay</span><br>    <span class="token keyword">const</span> res <span class="token operator">=</span> wait<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    wait <span class="token operator">=</span> wait<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolveAfter</span><span class="token punctuation">(</span>msPerOp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> res<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Now we can, as usual, wrap the promise and call with no worries, the operations are magically delayed:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> slowFetch <span class="token operator">=</span> <span class="token function">rateLimit1</span><span class="token punctuation">(</span>fetch<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>urls<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">u</span> <span class="token operator">=></span> <span class="token function">slowFetch</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">raw</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>raw<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=></span> p<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">pages</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The 1-rate-limiter can also be elegantly implemented on top of serializer with the pitfall of unnecessarily delaying the first operation:</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">rateLimit1</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> msPerOp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> wait <span class="token operator">=</span> <span class="token function">serializePromises</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolveAfter</span><span class="token punctuation">(</span>msPerOp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>a</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2>Rate limiting multiple operations</h2><p>Many APIs feature soft rate limits instead: they allow <code>M request per N seconds</code>. That is not equivalent to <code>1 request per N/M seconds</code>! Converting the multiple rate limit into individual one does fulfil the rate limit, but is overly harsh and non-optimal. Let's see this through examples.</p><h3>Difference from individual rate limit, by example</h3><p>Suppose you're flying a plane, and the airline allows 10 kg of luggage per passenger. If you're travelling with a girl, and have one 16-kg bag with both your things. At the check-in desk you're asked to take out half the stuff in your bag to make two 8-kg items. While formally correct, it feels idiotic — you still add the exact same weight to the plane! But now, why would you enforce such a stupid restriction on your own operations if you can do better?</p><p>Closer to the topic, let's try 2-req-per-2-sec rate limit for operations lasting 2 seconds. If you immediately fire 2 requests, you're done in 2 seconds:</p><pre><code>----| 2 seconds, all done!
----|
</code></pre><p>Converting this into 1-req-per-1-sec delays the second request by 1s, and now the same 2 requests take 3 seconds! You just lost a second for no reason.</p><pre><code>----  | 3 seconds
  ----|
</code></pre><h3>Understanding</h3><p>To understand what we should do, let's have a closer look at the 1-rate-limit. We essentially make a queue of promises that never resolve closer than <code>delay</code> apart. We use the resolutions to start the next operations, and don't care about its termination at all:</p><pre><code>*--*--     *--*--
</code></pre><p>This view extends to N-rate-limit: create N independent queues and put these into a circular queue (yes, a queue of queues makes a good <em>in Soviet Russia</em> joke):</p><pre><code>*--*-- *--*--
 *-- *--*--  *--
 *--  *-- *--    *--
</code></pre><p>The individual queues are unchanged, and never fire more than 1 operation per N seconds. Thus, M queues can fire at most M operations during the window.</p><h3>Implementing</h3><p>With this plan in mind, we can generalize the implementation:</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">rateLimit</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> windowMs<span class="token punctuation">,</span> reqInWindow <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// A battery of 1-rate-limiters</span><br>  <span class="token keyword">const</span> queue <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>reqInWindow<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">rateLimit1</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> windowMs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// Circular queue cursor</span><br>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>a</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// to enqueue, we move the cursor...</span><br>    i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> reqInWindow<span class="token punctuation">;</span><br>    <span class="token comment">// and return the rate-limited operation.</span><br>    <span class="token keyword">return</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2>Preventing queue overflow</h2><p>Just as before, we run into problems if the operations are consistently inserted into the queue faster than the rate limit. The solution is the same: once the queue exceeds the specified number of items, we immediately reject the incoming operations.</p><h2>Combining with concurrency limiting</h2><p>Now that we know how to limit both the rate and the number of simultaneously running operations, and since neither is a substitute for another, we want a way to combine the two limits. But can we build the joint rate/concurrency limiter by composing the primitive limiters? Turns out we can, but should carefully choose the order.</p><p><code>rateLimit(concurrencyLimit(fetch, N), ms)</code>, limits the rate at which the operations enter the concurrency-limit queue. Serialized (1-concurrent) promises rate-limited to 1 second break this combination. Suppose the first operation runs for 2 seconds, and during that time we throw 2 fast operations, O_2 and O_3 (say, 10 ms each) into the serializer. Instead of waiting for 1 second, the O_3 starts right after O_2 completes, or 10ms after it starts, breaking the rate limit.</p><p><code>concurrencyLimit(rateLimit(fetch, ms), N)</code> limits the number of operations in the rate-limit queue. Since the rate limiter only sees N operations at a time, it has no chance to fire more than N, which is exactly what we want. Hence, <strong>Chaining Rule 1: limit concurrency before rate.</strong></p><h2>Use cases</h2><p>The classic and most appropriate rate-limiting use case is for API requests. But now that you know the pattern, you will see it in your own tasks and, hopefully, use it ;-)</p><p>Promise-based rate limiting is a great way to quickly hack together a safe API wrapper without depending on the underlying HTTP / TCP / WebSocket client.</p><p>Frankly, other use cases I can come up with off the top of my head (render throttling and preventing too many e-mail notifications) are better served by batching. Maybe, you'll have better luck.</p><h2>Summary</h2><p>We've learnt to rate-limit promise-based APIs, both for the simple &quot;1-action-per-N-seconds&quot; and the more general M-actions case. Together with the previously discussed concurrency limiter, these patterns allow us to build robust service gateways with node.js, safely call external APIs and do all the other things you come up with.</p><p>Planning note: I've decided to throw away the excessively tricky part on load balancing and go with super fun and useful posts on <em>batching</em> and <em>handling failure</em>. I have RSS now, so be sure to stay tuned!</p><p><strong>Advanced Promise Coordination Series</strong></p><ul><li><a href="/2018/06/20/serialize-promises/">Serialization and Concurrency Limiting</a></li><li><a href="/2018/07/07/rate-limit-promises/">Rate Limiting</a></li></ul></div><span class="share"><div><a href="https://twitter.com/share?url=https://blog.thoughtspile.tech/2018/07/07/rate-limit-promises/&text=Advanced Promise Coordination: Rate Limiting by @thoughtspile" target="_blank" rel="noopener">Tweet</a></div><div id="share-button"><a>Share</a></div><div><a href="https://twitter.com/search?q=https://blog.thoughtspile.tech/2018/07/07/rate-limit-promises/" target="_blank" rel="noopener">Discuss on Twitter</a></div></span><div class="social-links"><a href="https://twitter.com/thoughtspile" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://mastodon.online/@thoughtspile" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg></a><a href="https://www.linkedin.com/in/vklepov/" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a href="/atom.xml" class="link--bare" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="rss" class="svg-inline--fa fa-rss fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8 0 416 186.2 416 416c0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96C14.3 96 0 81.7 0 64zM128 416c0 35.3-28.7 64-64 64s-64-28.7-64-64s28.7-64 64-64s64 28.7 64 64zM32 160c159.1 0 288 128.9 288 288c0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224c-17.7 0-32-14.3-32-32s14.3-32 32-32z"></path></svg></a></div><a href="https://buymeacoffee.com/thoughtspile" class="link--bare bmc-card" target="_blank" rel="noopener"><div><b>Hello, friend!</b> My name is Vladimir, and I love writing about web development. If you got down here, you probably enjoyed this article. My goal is to become an independent content creator, and you'll help me get there by <span class="bmc">buying me a coffee!</span></div><img src="/images/bmc.png" class="bmc-image"></a><div class="post-related"><div class="post-sibling"><span class="post-siblings__direction">More?</span> <a class="tag-link-link" href="/">All articles ever</a> <a class="tag-link-link" href="/tags/promises" rel="tag">promises</a> <a class="tag-link-link" href="/tags/javascript" rel="tag">javascript</a> <a class="tag-link-link" href="/tags/programming" rel="tag">programming</a> <a class="tag-link-link" href="/tags/high availability" rel="tag">high availability</a></div><a class="link--bare post-sibling" href="/2018/06/20/serialize-promises/"><span class="post-siblings__direction">Older?</span> <span class="link__text">Advanced Promises Coordination: Serialization and Concurrency Limiting</span> </a><a class="link--bare post-sibling" href="/2018/07/14/docx-is-a-zip-archive/"><span class="post-siblings__direction">Newer?</span> <span class="link__text">Quick Tip: docx is a zip Archive</span></a></div></article><script async src="/js/share.js"></script></div></body></html>
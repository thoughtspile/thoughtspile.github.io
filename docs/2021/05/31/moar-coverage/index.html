<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="yandex-verification" content="635edef3908320be"><meta name="google-site-verification" content="1-m0w7Up8df1sn0230jxfTKKZ4jLeln_Em1tcyfU0qw"><meta name="color-scheme" content="dark light"><meta property="og:type" content="article"><meta property="og:title" content="How to increase test coverage FAST"><meta property="og:url" content="https://blog.thoughtspile.tech/2021/05/31/moar-coverage/"><meta property="og:site_name" content="Vladimir Klepov as a Coder"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2021-05-31T00:00:00.000Z"><meta property="article:author" content="Vladimir Klepov"><meta property="article:tag" content="testing"><meta property="article:tag" content="programming"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@thoughtspile"><title>How to increase test coverage FAST</title><link rel="stylesheet" href="/css/style.css?ts=1675533053901"><link rel="canonical" href="https://blog.thoughtspile.tech/2021/05/31/moar-coverage/"><link rel="alternate" href="/atom.xml" title="Vladimir Klepov as a Coder" type="application/atom+xml"><script defer="defer" data-domain="blog.thoughtspile.tech" src="https://t.thoughtspile.tech/js/script.js"></script></head><body class="max-width mx-auto px3"><div class="content index"><a href="/" id="header" class="header header--post"><div id="logo"></div><header id="title"><h1>Vladimir Klepov as a Coder</h1></header></a><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">How to increase test coverage FAST</h1></header><div class="content" itemprop="articleBody"><p>The second quarter is coming to an end. I suppose a lot of my fellow developers are struggling to meet their ambitious KPI of &quot;20% more test coverage&quot;. Fear not — I'll show you a couple of neat tricks that will up your coverage game in no time, so that you can go on with your life (a handy bonus for meeting your goals and exceeding all expectations warranted).</p><h2>Verbose code is bro</h2><p>When it comes to cope coverage, verbose code covered with tests is your best friend. Compare the following snippets:</p><pre class="language-js"><code class="language-js"><span class="token comment">// not bro</span><br><span class="token keyword">const</span> <span class="token function-variable function">isEvenBad</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span><br><span class="token comment">// bro</span><br><span class="token keyword">function</span> <span class="token function">isEvenBro</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> counter<span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        counter <span class="token operator">=</span> <span class="token operator">-</span>x<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        counter <span class="token operator">=</span> x<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">while</span> <span class="token punctuation">(</span>counter <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        counter <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>These functions do the same thing. The key difference is that the first one, when fully tested, gives you just 1 covered line, while the second one is 140% better with 16! Moreover, if you write new tests for the second function, you'll earn a lot of credit with the team for maintaining such a complicated piece of code.</p><p>If you notice a co-worker rewriting a well-tested function into a simpler version, make sure to reject his pull request — lowering test coverage and &quot;not understanding the whole complexity&quot; are two great objections.</p><h2>Choose the right metrics</h2><p>The next point is quite obvious — if you measure several coverage metrics, report the highest one. Usually, function coverage is the one to use, while conditional / branch coverage is normally lower and should not be mentioned. It's not to say that it's not helpful at all — you can refer to its value at the start of the quarter to impress your boss! Learn the formula &quot;We went from 20% <em>(branch, of course)</em> coverage to 60% (<em>function coverage</em>) in just 3 months&quot;. Make sure to include a screenshot of a coverage report with a lot of green stuff in your PowerPoint presentation.</p><p>Another great trick is to exclude untested code from coverage calculations. <a href="https://jestjs.io" target="_blank" rel="noopener">Jest</a> is an amazing tool that does it by default for JS — only the code that is imported in your tests takes is taken into account.</p><h2>Decompose the smart way</h2><p>So, function coverage is the right metric to report — but how to increase it? You might naively think that fewer function = better, since stuffing your code into one huge function and testing it yields 100% coverage. That's the spirit, but cramming all the code into a single function is difficult for modern programs. Instead, use the 2 patterns:</p><ul><li>Find a well-tested function, and split it into as many functions as possible — every one is +1 covered function! Make sure to cal it &quot;decomposing&quot;.</li><li>Look for functions that are not tested and try to stick their code into the tested ones.</li></ul><h2>Write generic tests</h2><p>I heard modern test frameworks come with lots of differnt assertions — you can compare things, test them with regexes and what not. I don't know who came up with that, but you only need one assertion: <em>function X does not throw.</em> It'll give you the same coverage as the other types, but is easier to write and less likely to break. A perfect test case for our <code>isEvenBro</code> would be</p><pre class="language-js"><code class="language-js"><span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">isEvenBro</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>So just take a function, stick some arguments that don't make it explode, and call it a day. Oh, and if it does explode, you can add an <code>expect(...).toThrow()</code> as a corner case test.</p><h2>Configuration over code</h2><p>Conditionals are bad, because they lower branch coverage. In a perfect world, you'd be working with</p><pre class="language-js"><code class="language-js"><span class="token keyword">return</span> <span class="token function">ifElse</span><span class="token punctuation">(</span>x <span class="token operator">></span> y<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// not some</span><br><span class="token keyword">return</span> x <span class="token operator">></span> y <span class="token operator">?</span> x <span class="token operator">:</span> y<span class="token punctuation">;</span></code></pre><p>See? The first version has 0 branches, and you can get 100% coverage with 2 tests for <code>ifElse</code> helper.</p><p>If a co-worker of yours is a traitor and doesn't like <code>ifElse</code>, try something less in-your-face:</p><pre class="language-js"><code class="language-js"><span class="token comment">// Good pattern to replace switch {}</span><br><span class="token keyword">const</span> months <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'January'</span><span class="token punctuation">,</span> <span class="token string">'February'</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token function-variable function">monthName</span> <span class="token operator">=</span> <span class="token parameter">mNumber</span> <span class="token operator">=></span> months<span class="token punctuation">[</span>mNumber<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><p>Oh, and while we're at it, a great place for front-end devs to hide the conditionals is CSS:</p><pre class="language-css"><code class="language-css"><span class="token selector">.Input[data-active=true]</span> <span class="token punctuation">{</span> <span class="token property">color</span><span class="token punctuation">:</span> black <span class="token punctuation">}</span><br><span class="token comment">/* setAttribute('data-active', isActive) */</span></code></pre><h2>Don't test if you are not obliged to</h2><p>The final thing is what I call strategic thinking. Writing tests is easier when you have fewer tests. In the next quarter, avoid promising anything test-related, and just code happily and freely, like a bird, without the tests to slow you down. By the time you commit to another &quot;20% more test this quarter&quot; you'll hopefully have a lot of untested code waiting around for you to meet your goals.</p><hr><p>On a more serious note, though:</p><ol><li>Stop being so fucking serious about code coverage.</li><li>Coverage is a bad KPI, don't use it just because it's the easiest quality metric to measure.</li><li>Havig X% coverage only tells you that X% of your code does not throw under <em>some</em> conditions.</li><li>When you do talk about X% coverage, make sure it's the <em>lowest</em> metric measured on your <em>whole</em> codebase (especailly when X=100).</li><li>Code-as-configuration flies under the radar of most coverage metrics, be careful with it.</li></ol><p>Coverage is a tool to help you find missed requirements that are described in your code, not an end goal.</p></div><span class="share"><div><a href="https://twitter.com/share?url=https://blog.thoughtspile.tech/2021/05/31/moar-coverage/&text=How to increase test coverage FAST by @thoughtspile" target="_blank" rel="noopener">Tweet</a></div><div id="share-button"><a>Share</a></div><div><a href="https://twitter.com/search?q=https://blog.thoughtspile.tech/2021/05/31/moar-coverage/" target="_blank" rel="noopener">Discuss on Twitter</a></div></span><div class="post-related">More? <a class="tag-link-link" href="/">All articles ever</a> <a class="tag-link-link" href="/tags/testing" rel="tag">testing</a> <a class="tag-link-link" href="/tags/programming" rel="tag">programming</a></div><div class="post-actions">Written in <time>2021</time> by&nbsp;your friend, <a href="/">Vladimir.</a> Follow&nbsp;me on&nbsp;<a href="https://twitter.com/thoughtspile" target="_blank" rel="noopener">Twitter</a> to&nbsp;get post updates. I&nbsp;have <a href="/atom.xml">RSS,</a> too. And you can <a class="bmc link--bare" href="https://buymeacoffee.com/thoughtspile" target="_blank" rel="noopener">buy me a coffee!</a></div><div class="post-siblings"><a class="link--bare" href="/2021/05/17/everything-about-react-refs/"><div class="post-siblings__direction">Older</div><span class="link__text">So you think you know everything about React refs</span> </a><a class="link--bare" href="/2021/06/02/eslint-restrict-syntax/"><div class="post-siblings__direction">Newer</div><span class="link__text">Become the master of your eslint with no-restricted-syntax</span></a></div></article><script async src="/js/share.js"></script></div></body></html>
<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="yandex-verification" content="635edef3908320be"><meta name="google-site-verification" content="1-m0w7Up8df1sn0230jxfTKKZ4jLeln_Em1tcyfU0qw"><meta property="og:type" content="article"><meta property="og:title" content="How useRef turned out to be useMemo&#39;s father"><meta property="og:url" content="https://blog.thoughtspile.tech/2021/04/05/useref-usememo/"><meta property="og:site_name" content="Vladimir Klepov as a Coder"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.thoughtspile.tech/images/hook-vader.jpg"><meta property="article:published_time" content="2021-04-05T00:00:00.000Z"><meta property="article:author" content="Vladimir Klepov"><meta property="article:tag" content="react"><meta property="article:tag" content="programming"><meta property="article:tag" content="frontend"><meta property="article:tag" content="hooks"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@thoughtspile"><meta name="twitter:image" content="https://blog.thoughtspile.tech/images/hook-vader.jpg"><title>How useRef turned out to be useMemo&#39;s father</title><link rel="stylesheet" href="/css/style.css"><link rel="canonical" href="https://blog.thoughtspile.tech/2021/04/05/useref-usememo/"><link rel="alternate" href="/atom.xml" title="Vladimir Klepov as a Coder" type="application/atom+xml"></head><body class="max-width mx-auto px3"><div class="content index"><a href="/" id="header" class="header header--post"><div id="logo"></div><header id="title"><h1>Vladimir Klepov as a Coder</h1></header></a><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">How useRef turned out to be useMemo&#39;s father</h1></header><div class="content" itemprop="articleBody"><p>It's no secret that react's <code>useCallback</code> is just sugar on top of <code>useMemo</code> that saves the children from having to see an arrow chain. As <a href="https://reactjs.org/docs/hooks-reference.html" target="_blank" rel="noopener">the docs</a> go:</p><pre class="language-jsx"><code class="language-jsx"><span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">onChange</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>onChange<span class="token punctuation">,</span> id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// is equivalent to</span><br><span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">onChange</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>onChange<span class="token punctuation">,</span> id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><img src="/images/hook-vader.jpg" alt=""></p><blockquote><p>A less known, probably useless, but very fun, fact: you can actually pass something other than a function to <code>useCallback</code> and have it memoized.</p><pre class="language-js"><code class="language-js"></code></pre></blockquote><p>const stableValue = useCallback({ please: 'dont do this' }, []); // yes-yes, stableValue is that object, as of react@17.0.2</p><pre><code>
As I got more into hooks, I've been surprised to realize how similar `useMemo` itself is to `useRef`. Think about it that way: `useRef` does a very simple thing — persists a value between render function calls and lets you update it as you wish. `useMemo` just provides some automation on top for updating this value when needed. Recreating `useMemo` is fairly straightforward:

```jsx
const memoRef = useRef();
const lastDeps = useRef(deps);
// some shallow array comparator, beside the point
if (!arrayEquals(deps, lastDeps.current)) {
    memoRef.current = factory();
    lastDeps.current = deps;
}
const memoized = memoRef.current;
// ... is equivalent to const memoized = useMemo(factory, deps);
</code></pre><p>As a special case, raw <code>useRef</code> is <em>almost</em> the same as <code>useMemo</code> with no deps, save for actually building the initial value on every render and then throwing it away:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> stableData <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>current<span class="token punctuation">;</span> <span class="token comment">// same as useMemo(() => {}, []);</span></code></pre><p>Treating <code>useRef</code> as a stripped-down <code>useMemo</code> can prove useful in some cases. If the built-in caching mechanism does not work for you, <code>useRef</code> is a perfect way to tweak it. Some motivational examples:</p><ul><li>Actually cache all the previous results using eg <a href="https://github.com/caiogondim/fast-memoize.js" target="_blank" rel="noopener">fast-memoize.</a> <code>useMemo</code> appears to just cache the last result, which is a good default.</li><li>Support true array dependencies with dynamic length: <code>useArrayMemo(() =&gt; hash(arrayValues), arrayValues)</code></li><li>Use an object instead of an array: <code>useObjectMemo(() =&gt; props, props)</code> gives you the same reference unless a prop has changed.</li><li>More generally, allow any custom comparator for deps: <code>useCustomMemo(() =&gt; lib.sum(table1, table2), [table1, table2], (a, b) =&gt; a.equals(b))</code></li></ul><p>These may not be the most common use cases, but it's good to know that this is doable, and that <code>useRef</code> is there to help you in case you ever need it.</p><blockquote><p>On to another fun fact — you can make <code>useMemo</code> return a constant-reference <code>RefObject</code> box, equivalent to <code>useRef</code>. It's not clear why you would want that.</p><pre class="language-js"><code class="language-js"></code></pre></blockquote><p>useMemo(() =&gt; ({ current: initialValue }), [])</p><pre><code>
---

So, wrapping up:

1. `useCallback` is just tiny sugar on top of `useMemo`.
2. `useMemo` is just `useRef` with auto-update functionality.
3. You can build customized versions of `useMemo` with `useRef`.
4. You _can_ bend `useCallback` to be a `useMemo`, and you can get `useMemo` to be a `useRef`, but that doesn't mean you _should._

On the other hand, `useState` (and `useReducer`) is an entirely different cup of tea, since they can trigger a rerender on update. More on these guys in the next post!
</code></pre></div><span class="share"><div><a href="https://twitter.com/share?url=&text= by @thoughtspile" target="_blank" rel="noopener">Tweet</a></div><div id="share-button"><a>Share</a></div><div><a href="https://twitter.com/search?q=https://blog.thoughtspile.tech/2021/04/05/useref-usememo/" target="_blank" rel="noopener">Discuss on Twitter</a></div></span><div class="post-related">More? <a class="tag-link-link" href="/">All articles ever</a> <a class="tag-link-link" href="/tags/react" rel="tag">react</a> <a class="tag-link-link" href="/tags/programming" rel="tag">programming</a> <a class="tag-link-link" href="/tags/frontend" rel="tag">frontend</a> <a class="tag-link-link" href="/tags/hooks" rel="tag">hooks</a></div><div class="post-actions">Written in <time>2021</time> by&nbsp;your friend, <a href="/">Vladimir.</a> Follow&nbsp;me on&nbsp;<a href="https://twitter.com/thoughtspile" target="_blank" rel="noopener">Twitter</a> to&nbsp;get post updates. I&nbsp;have <a href="/atom.xml">RSS,</a> too. And you can <a class="bmc link--bare" href="https://buymeacoffee.com/thoughtspile" target="_blank" rel="noopener">buy me a coffee!</a></div><div class="post-siblings"><a class="link--bare" href="/2021/04/02/promise-timeout/"><div class="post-siblings__direction">Older</div><span class="link__text">How to timeout a promise</span> </a><a class="link--bare" href="/2021/04/07/better-usecallback/"><div class="post-siblings__direction">Newer</div><span class="link__text">Did I just build a better useCallback?</span></a></div></article><script async src="/js/share.js"></script></div></body></html><script type="text/javascript">(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-121445688-1', 'auto');
    ga('send', 'pageview');</script>
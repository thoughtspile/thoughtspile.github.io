<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="yandex-verification" content="635edef3908320be"><meta name="google-site-verification" content="1-m0w7Up8df1sn0230jxfTKKZ4jLeln_Em1tcyfU0qw"><meta property="og:type" content="article"><meta property="og:title" content="useLayoutEffect is a bad place for deriving state"><meta property="og:url" content="https://blog.thoughtspile.tech/2021/09/21/useeffect-derived-state/"><meta property="og:site_name" content="Vladimir Klepov as a Coder"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2021-09-21T00:00:00.000Z"><meta property="article:author" content="Vladimir Klepov"><meta property="article:tag" content="react"><meta property="article:tag" content="programming"><meta property="article:tag" content="frontend"><meta property="article:tag" content="hooks"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@thoughtspile"><title>useLayoutEffect is a bad place for deriving state</title><link rel="stylesheet" href="/css/style.css"><link rel="canonical" href="https://blog.thoughtspile.tech/2021/09/21/useeffect-derived-state/"><link rel="alternate" href="/atom.xml" title="Vladimir Klepov as a Coder" type="application/atom+xml"><script defer="defer" data-domain="blog.thoughtspile.tech" src="https://t.thoughtspile.tech/js/script.js"></script></head><body class="max-width mx-auto px3"><div class="content index"><a href="/" id="header" class="header header--post"><div id="logo"></div><header id="title"><h1>Vladimir Klepov as a Coder</h1></header></a><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">useLayoutEffect is a bad place for deriving state</h1></header><div class="content" itemprop="articleBody"><p>Today we'll talk about updating state inside useLayoutEffect in reaction to prop changes. Will it work? Is it safe? Are there <em>better</em> ways to implement such state changes? TLDR: it works, but leaves you with an extra DOM update that may break stuff.</p><p>As we all know, useLayoutEffect is called before the browser has painted the DOM. This might lead you to believe it's OK to create derived state with useLayoutEffect — we'll immediately update with the new state, and the user won't notice anything, right? As we'll shortly see, wrong. Let me introduce an example — transition manager.</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Transition</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> active <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> prevActive <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>exiting<span class="token punctuation">,</span> setExiting<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    prevActive<span class="token punctuation">.</span>current <span class="token operator">&amp;&amp;</span> <span class="token function">setExiting</span><span class="token punctuation">(</span>prevActive<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    prevActive<span class="token punctuation">.</span>current <span class="token operator">=</span> active<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>active<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">onTransitionEnd</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setExiting</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> isExiting <span class="token operator">=</span> c<span class="token punctuation">.</span>key <span class="token operator">===</span> exiting<span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>key <span class="token operator">!==</span> active <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isExiting<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token comment">// assume a suitable transform + transition on .exit</span><br>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>key<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>isExiting <span class="token operator">?</span> <span class="token string">"exit"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span><span class="token plain-text">);<br>};</span></code></pre><p><code>Transition</code> accepts app screens as keyed children and only renders the one with <code>active</code> key, but also adds a nice effect when moving between the screens — like a lightweight react-transition-group. For that, we keep the previously active child mounted while the transition is playing — that's handled by <code>exiting</code>. When <code>active</code> changes, we activate <code>exiting</code>, play the animation, then remove <code>exiting</code>. Should be good.</p><p>But (see for yourself <a href="https://codesandbox.io/s/funny-goodall-txp3m?file=/src/App.js" target="_blank" rel="noopener">in the codesandbox</a>) the transition doesn't play. What went wrong? Thinking about it, useLayoutEffect lets you peek into the actual DOM created by your render. So, even though the browser didn't paint, the DOM for the &quot;virtual&quot; state was there. The DOM sequence is:</p><ol><li>DOM is <code>&lt;Screen1 /&gt;</code>, as expected</li><li>paint</li><li>Change DOM to <code>&lt;Screen2 /&gt;</code> <strong>(OH SHI)</strong></li><li>Change DOM to <code>&lt;Screen1 exiting /&gt;&lt;Screen2 /&gt;</code>, as expected</li><li>paint, paint, paint transition frames</li><li>Change DOM to <code>&lt;Screen2 /&gt;</code>, as expected</li><li>paint</li></ol><p>While changing the DOM to <code>&lt;Screen2 /&gt;</code> for a moment without even painting seems like nothing, it's not. Instead of setting a class on the exiting screen1 and rendering screen2, react unmounts screen1, then mounts screen2 and еру exiting screen1, leaving us with a whole extra screen1 remount. Being wasteful is not the main problem here. The browser loses track of screen1 in between remounts, thinks the screen with the &quot;exiting&quot; class had just appeared out of nowhere, and doesn't play the transition.</p><p>Technically, we could work around this by replacing transition with an animation, but that would still leave us with a useless remount (whole screens are rather heavy) and lost DOM state (like the inner scrolls in screen1 would get unset, leading to strange flickering). We obviously need to activate <code>exiting</code> and change <code>active</code> in the same render — but how can we do that?</p><h2>Derived state</h2><p>So, as far as we know, setting state derived from props in an effect causes a parasitical DOM update that is wasted at best, and may break stuff. So, the state model that requires us to change state in reaction to prop change will not work. Let's find a more suitable state model, then!</p><p>When your state is purely derived from props, it's an easy feat:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">[</span>fullName<span class="token punctuation">,</span> setFullName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">setFullName</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>firstName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>lastName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>props<span class="token punctuation">.</span>firstName<span class="token punctuation">,</span> props<span class="token punctuation">.</span>lastName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// becomes...</span><br><span class="token keyword">const</span> fullName <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>firstName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>lastName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>props<span class="token punctuation">.</span>firstName<span class="token punctuation">,</span> props<span class="token punctuation">.</span>lastName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// useMemo is obviously optional:</span><br><span class="token keyword">const</span> fullName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>firstName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>lastName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code></pre><p>Our case is more complex, since we want to derive state from props, but <em>also</em> to set it imperatively from <code>onTransitionEnd</code>. For that, we need to <em>decompose</em> the state into a part that depends on props, and some other state doesn't need to be updated on prop change. An alternate model that cleanly plays with react here would be:</p><ol><li><code>props.active</code> is the currently active screen</li><li><code>lastSettled</code> via <code>useState</code> is the last screen we've cleanly transitioned to</li></ol><p>Transition then plays as long as <code>lastSettled !== props.active</code>, and <code>lastSettled</code> is updated on transition end. Once you know the trick, the code is straightforward:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Transition</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> active <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>lastSettled<span class="token punctuation">,</span> setLastSettled<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>active<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> exiting <span class="token operator">=</span> lastSettled <span class="token operator">===</span> active <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> lastSettled<span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">onTransitionEnd</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setLastSettled</span><span class="token punctuation">(</span>active<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token punctuation">{</span>children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token comment">// same as before</span><br>      <span class="token keyword">const</span> isExiting <span class="token operator">=</span> c<span class="token punctuation">.</span>key <span class="token operator">===</span> exiting<span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>key <span class="token operator">!==</span> active <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isExiting<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>key<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>isExiting <span class="token operator">?</span> <span class="token string">"exit"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text"><br>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>It works <a href="https://codesandbox.io/s/funny-goodall-txp3m?file=/src/App.js" target="_blank" rel="noopener">(sandbox)</a>, and it's brilliant! The transition now plays, we get exactly 3 renders and 3 DOM updates, and we <em>also</em> handle a tricky case when <code>active</code> changes again while playing transition: in our previous model, we would abruptly finish the <code>s1 -&gt; s2</code> transition and transition again <code>s2 -&gt; s3</code>, while here the transition changes to <code>s1 -&gt; s3</code>. Also, <code>s1 -&gt; s2 -&gt; s1</code> transition is automatically canceled and needs no special handling.</p><h2>Buffering prop updates</h2><p>The only problem with our &quot;find the right model&quot; approach is is that doing it is much harder than saying. I'm not some state genius, and honestly spent a whole day trying different options, and the final idea only came once I gave up and opened a beer. We need something more reliable and reproducible.</p><p>We can't set <code>exiting</code> state immediately when <code>props.active</code> changes (bring setState closer to props change). Instead, we can make <code>active</code> and <code>exiting</code> change simultaneously by delaying the <code>active</code> update. Let's ignore <code>props.active</code> during render, but use an effect to copy it into <code>state.active</code> (setting <code>exiting</code> simultaneously) and render based on the state. I'd call this technique &quot;buffering&quot;:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Transition</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> <span class="token literal-property property">active</span><span class="token operator">:</span> _active <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> active<span class="token punctuation">,</span> exiting <span class="token punctuation">}</span><span class="token punctuation">,</span> setTransition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token literal-property property">active</span><span class="token operator">:</span> _active<span class="token punctuation">,</span><br>    <span class="token literal-property property">exiting</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// this line skips transition on mount</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>_active <span class="token operator">!==</span> active<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">setTransition</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">active</span><span class="token operator">:</span> _active<span class="token punctuation">,</span> <span class="token literal-property property">exiting</span><span class="token operator">:</span> active <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>_active<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">onTransitionEnd</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTransition</span><span class="token punctuation">(</span><span class="token punctuation">{</span> active <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token punctuation">{</span>children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token comment">// same as before</span><br>      <span class="token keyword">const</span> isExiting <span class="token operator">=</span> c<span class="token punctuation">.</span>key <span class="token operator">===</span> exiting<span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>key <span class="token operator">!==</span> active <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isExiting<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>key<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>isExiting <span class="token operator">?</span> <span class="token string">"exit"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text"><br>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>This works, too (see <a href="https://codesandbox.io/s/funny-goodall-txp3m?file=/src/App.js" target="_blank" rel="noopener">the sandbox</a> again). The DOM sequence here is:</p><ol><li><code>&lt;screen1 /&gt;</code></li><li><code>&lt;screen1 /&gt;</code> again with prop <code>active=&quot;v2&quot;</code> — not a big deal, React handles that</li><li><code>&lt;screen1 exiting /&gt;&lt;screen2 /&gt;</code> our transition, rendered cleanly</li><li><code>&lt;screen2 /&gt;</code></li></ol><p>Much better! We haven't completely eliminated a parasitical render, but instead of a full <code>&lt;screen1 /&gt;</code> remount we just compare the vDOM and do nothing with the real DOM.</p><h2>Stuff that didn't work</h2><h3>setState in render</h3><p>As a dirty experiment, we could skip the <code>effect</code> and set state in render just to see what happens:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Transition</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> active <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> prevActive <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    prevActive<span class="token punctuation">.</span>current <span class="token operator">=</span> active<br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>active<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>exiting<span class="token punctuation">,</span> setExiting<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>active <span class="token operator">!==</span> prevActive<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">setExiting</span><span class="token punctuation">(</span>prevActive<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token comment">// etc</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>As expected, this is a clusterfuck — the renders triggered by <code>setExiting</code> appear to run, but the resulting DOM is ignored and react appears to throw away the state update (<code>exiting</code> is not there on the next normal render).</p><h3>Fancy &quot;semi-state&quot; hook</h3><p>As we've discovereed, there is no way to set state after a prop update without an itermediate DOM update. But you know what can be set during render? A <code>ref</code>! We set the ref synchronously inside render, we unset it as usual on transition end. Since assigning to <code>ref.current</code> does not trigger a re-render, we also force rerender by &quot;setting&quot; a useless state. Here you go:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">Transition</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> active <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// basic usePrevious technique</span><br>  <span class="token keyword">const</span> prevActive <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    prevActive<span class="token punctuation">.</span>current <span class="token operator">=</span> active<br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>active<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// exiting "state"</span><br>  <span class="token keyword">const</span> exiting <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// useless state to force rerender on transition finish</span><br>  <span class="token keyword">const</span> rerender <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">function</span> <span class="token function">flushExiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// unset exiting "state"</span><br>    exiting<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>    <span class="token comment">// force rerender</span><br>    <span class="token function">rerender</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>active <span class="token operator">!==</span> prevActive<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// immediately set exiting "state" on change</span><br>    exiting<span class="token punctuation">.</span>current <span class="token operator">=</span> prevActive<span class="token punctuation">.</span>current<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token comment">// as before</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>This appears to work in react basic mode, but, as expected when setting ref inside render, <em>will not work in concurrent mode™</em> Without getting into too much detail, the ref is shared between currently mounted and WIP branches, and both can unexpectedly set or unset it.</p><hr><p>So, wrapping up:</p><ol><li>Calling synchronizing state to props in <code>useLayoutEffect</code> makes react put the real DOM into an inconsistent state for a moment.</li><li>This parasitical render might be just wasted cycles, but can also mess with your CSS transitions and lose DOM state (like scrolls and focus).</li><li>The best approach is to come up with another state model that does not require you to change anything based on a prop change, but this might not always be trivial.</li><li>A simpler way is to &quot;delay&quot; the prop udate by copying the prop into a state, and then updating it together with the derived state.</li></ol></div><span class="share"><div><a href="https://twitter.com/share?url=&text= by @thoughtspile" target="_blank" rel="noopener">Tweet</a></div><div id="share-button"><a>Share</a></div><div><a href="https://twitter.com/search?q=https://blog.thoughtspile.tech/2021/09/21/useeffect-derived-state/" target="_blank" rel="noopener">Discuss on Twitter</a></div></span><div class="post-related">More? <a class="tag-link-link" href="/">All articles ever</a> <a class="tag-link-link" href="/tags/react" rel="tag">react</a> <a class="tag-link-link" href="/tags/programming" rel="tag">programming</a> <a class="tag-link-link" href="/tags/frontend" rel="tag">frontend</a> <a class="tag-link-link" href="/tags/hooks" rel="tag">hooks</a></div><div class="post-actions">Written in <time>2021</time> by&nbsp;your friend, <a href="/">Vladimir.</a> Follow&nbsp;me on&nbsp;<a href="https://twitter.com/thoughtspile" target="_blank" rel="noopener">Twitter</a> to&nbsp;get post updates. I&nbsp;have <a href="/atom.xml">RSS,</a> too. And you can <a class="bmc link--bare" href="https://buymeacoffee.com/thoughtspile" target="_blank" rel="noopener">buy me a coffee!</a></div><div class="post-siblings"><a class="link--bare" href="/2021/06/14/faster-pre-commit/"><div class="post-siblings__direction">Older</div><span class="link__text">How we made our pre-commit check 7x faster</span> </a><a class="link--bare" href="/2021/09/22/dev-warnings/"><div class="post-siblings__direction">Newer</div><span class="link__text">Build better libraries, use dev warnings</span></a></div></article><script async src="/js/share.js"></script></div></body></html>
<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="yandex-verification" content="635edef3908320be"><meta name="google-site-verification" content="5nfOA5k_QcuAP9zbAASIV24DlAZG7BWxRVYoNlKCAoc"><meta name="color-scheme" content="dark light"><meta property="og:type" content="article"><meta property="og:title" content="Build better libraries, use dev warnings"><meta property="og:url" content="https://thoughtspile.github.io/2021/09/22/dev-warnings/"><meta property="og:site_name" content="Vladimir Klepov as a Coder"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://thoughtspile.github.io/images/warn-trace.png?invert"><meta property="article:published_time" content="2021-09-22T00:00:00.000Z"><meta property="article:author" content="Vladimir Klepov"><meta property="article:tag" content="open source"><meta property="article:tag" content="programming"><meta property="article:tag" content="javascript"><meta property="article:tag" content="developer experience"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@thoughtspile"><meta name="twitter:image" content="https://thoughtspile.github.io/images/warn-trace.png?invert"><title>Build better libraries, use dev warnings</title><link rel="stylesheet" href="/css/style.css?ts=1708188942856"><link rel="canonical" href="https://thoughtspile.github.io/2021/09/22/dev-warnings/"><link rel="alternate" href="/atom.xml" title="Vladimir Klepov as a Coder" type="application/atom+xml"><script defer="defer" data-domain="thoughtspile.github.io" src="https://t.thoughtspile.tech/js/script.js"></script></head><body class="max-width mx-auto px3"><div class="content index"><a href="/" id="header" class="header header--post"><div id="logo"></div><header id="title"><h1>Vladimir Klepov as a Coder</h1></header></a><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Build better libraries, use dev warnings</h1><div class="post__date">Written in <time>2021</time></div></header><div class="content" itemprop="articleBody"><p>Suppose you're making a cool library that sums numbers in an array. You add a new option, <code>inital</code>, that lets users specify an initial value for the summation:</p><pre class="language-js"><code class="language-js"><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">inital</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 13</span></code></pre><p>Oh no! You made a typo — of course you meant <code>initial</code>, not <code>inital</code>. What's done is done, and you're stuck with a million users relying on your <code>inital</code> option. Here's what you can do:</p><ol><li>Keep the <code>inital</code> option forever. You bconfuse the users and become known as <em>that guy who can't spell.</em></li><li>Rename <code>inital</code> to <code>initial</code> immediately. Everyone has to rewrite their code that was working fine (thinking you're a jerk), and the apps whose authors don't follow the changelog explode.</li></ol><p>As a responsible maintainer, you decide to go the third way — support both <code>initial</code> and <code>inital</code> for now, schedule dropping <code>inital</code> in v2, and let your users know a breaking change is coming. You fix the issue with this ingenious code:</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> ops <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'inital'</span> <span class="token keyword">in</span> ops<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'dont use inital option'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span> initial <span class="token operator">=</span> <span class="token punctuation">(</span>ops<span class="token punctuation">.</span>inital <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token operator">=</span> ops<span class="token punctuation">;</span><br>    <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s<span class="token punctuation">,</span> a</span><span class="token punctuation">)</span> <span class="token operator">=></span> s <span class="token operator">+</span> a<span class="token punctuation">,</span> initial<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Not so fast! Here are some problems with this fix:</p><ol><li>Production bundle size of your library has grown by 25% thanks to the bundled error messages.</li><li>The apps relying on <code>inital</code> option run slower, since <code>console.warn</code> is fairly heavy.</li><li>Dev console is all covered in your <code>inital</code> message, and it's easier to miss important warnings from other libraries.</li><li>If the dev uses a lot of libraries, it's not clear exactly what caused the error.</li></ol><p>Let's handle these issues one by one.</p><h2>Remove warning from production</h2><p>The first two issues can be fixed by removing the warning code from production bundle. Easier than it seems:</p><pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token string">'inital'</span> <span class="token keyword">in</span> ops<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'dont use inital option'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Your user's bundler replaces <code>process.env.NODE_ENV</code> with a literal string, <code>&quot;production&quot;</code>, in production mode, turning the condition into <code>if ('production' === 'development')</code>, which is <code>if (false)</code>, and then the minifier's <a href="https://lihautan.com/dead-code-elimination/" target="_blank" rel="noopener">dead code elimination</a> removes the <code>if</code> block altogether, since it can never get executed. All the warning code, and even the <code>ops.inital</code> check, are gone. Pretty smart!</p><p>This works in <a href="https://webpack.js.org/guides/production/#specify-the-mode" target="_blank" rel="noopener">webpack</a>, <a href="https://parceljs.org/production.html#optimisations" target="_blank" rel="noopener">parcel</a>, and <a href="https://github.com/rollup/rollup/issues/487" target="_blank" rel="noopener">rollup (with plugin-replace)</a>. Some of the biggest JS libraries, like <a href="https://github.com/facebook/react/blob/cae635054e17a6f107a39d328649137b83f25972/packages/react/npm/index.js" target="_blank" rel="noopener">react</a> and <a href="https://github.com/vuejs/vue/search?q=node_env" target="_blank" rel="noopener">vue,</a> use this technique, so you're in good company.</p><p>One nasty thing is that you must wrap the warning in a full <code>process.env.NODE_ENV === 'development'</code> condition manually each time — using any indirection <em>may</em> confuse the replacement algorithms and prevent code removal:</p><pre class="language-js"><code class="language-js"><span class="token comment">// devWarn becomes () => {}</span><br><span class="token keyword">function</span> <span class="token function">devWarn</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span> <span class="token operator">&amp;&amp;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token comment">// but the call with the string is not removed</span><br><span class="token function">devWarn</span><span class="token punctuation">(</span><span class="token string">'oh no'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// looking across module boundaries may not work</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> isDev<span class="token punctuation">,</span> env<span class="token punctuation">,</span> dev <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../env'</span><span class="token punctuation">;</span><br>isDev <span class="token operator">&amp;&amp;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ooh no'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> dev<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'no'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">(</span>env <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'no'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2>Error tracing</h2><p>Modern web apps use many different libraries. When a developer sees your message, it may not be obvious where it came from. A good first step is replacing <code>console.log</code> with a <code>warn</code> or <code>error</code> that fires with a nice expandable stack trace:</p><p><img src="/images/warn-trace.png?invert" alt=""></p><p>In some frameworks (looking at you, React) the stack trace may not be that useful. If that's your case, provide extra identification inside the message:</p><p><code>console.warn('[sum/useSum] dont use inital')</code></p><p>Wording the warnings is important, too. Our current &quot;inital is bad&quot; is confusing — what's wrong with that option? Is my code broken? What should I do? Make sure to provide the motivation for the change and an actionable fix. Here: we made a typo, the code is OK until v2, please move to an option with a normal name when you have the time. Here we go: <code>&quot;inital&quot; option was a typo and will be removed in v2 - use &quot;initial&quot;</code> Feel free to provide a link to relevant docs / discussions if it's a particularly complicated matter. Remember, the messages are removed from production bundle, so there's no reason to save keystrokes here.</p><h2>Log once</h2><p>Don't assume your users are stupid and bombard them with warnings — it's annoying and may drown other, more important, messages. I prefer showing every warning once — the users who care will clean up their code until no more warnings are left, and those who don't are free to go on with their business. Here's a way to do that:</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">warnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> logged <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>logged<span class="token punctuation">[</span>msg<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            logged<span class="token punctuation">[</span>msg<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>            console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><span class="token keyword">export</span> <span class="token keyword">const</span> warn <span class="token operator">=</span> <span class="token function">warnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>If you a particular warning really needs to fire several times, play around with <code>warnOnce</code> instancing — like <code>useMemo(warnOnce, [])</code> to warn once per React component instance.</p><hr><p>Dev warnings are not only helpful for deprecations and breaking change announcements. Incorrect API uses deserve a warning, too — for example, the user could pass two conflicting options, or an obscure error would be thrown soon and you'd like to explain what caused it. Most dev warnings are a sign of bad API design, but they're a helpful tool nonetheless.</p><p>Here are some tips for great dev warnings:</p><ul><li>Wrap your dev warnings into a <code>process.env.NODE_ENV === 'development'</code> condition to strip them from the production bundle. No abstractions here, please.</li><li>Make sure the source of the error is clear — use <code>console.warn / error</code> to show a nice stack trace and include the library name in the message itself.</li><li>Clearly explain what caused the warning, the consequences of ignoring it, and suggest a fix.</li><li>Don't drown the users in warnings — warn once.</li></ul><p>Hopefully, these tips will help you improve your library developer experience. Warning is caring.</p></div><span class="share"><div><a href="https://twitter.com/share?url=https://thoughtspile.github.io/2021/09/22/dev-warnings/&text=Build better libraries, use dev warnings by @thoughtspile" target="_blank" rel="noopener">Tweet</a></div><div id="share-button"><a>Share</a></div><div><a href="https://twitter.com/search?q=https://thoughtspile.github.io/2021/09/22/dev-warnings/" target="_blank" rel="noopener">Discuss on Twitter</a></div></span><div class="social-links"><a href="https://www.linkedin.com/in/vklepov/" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a href="https://github.com/thoughtspile" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a href="/atom.xml" class="link--bare" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="rss" class="svg-inline--fa fa-rss fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8 0 416 186.2 416 416c0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96C14.3 96 0 81.7 0 64zM128 416c0 35.3-28.7 64-64 64s-64-28.7-64-64s28.7-64 64-64s64 28.7 64 64zM32 160c159.1 0 288 128.9 288 288c0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224c-17.7 0-32-14.3-32-32s14.3-32 32-32z"></path></svg></a></div><a href="https://buymeacoffee.com/thoughtspile" class="link--bare bmc-card" target="_blank" rel="noopener"><div><b>Hello, friend!</b> My name is Vladimir, and I love writing about web development. If you got down here, you probably enjoyed this article. My goal is to become an independent content creator, and you'll help me get there by <span class="bmc">buying me a coffee!</span></div><img src="/images/bmc.png" data-no-preview class="bmc-image"></a><div class="post-related"><div class="post-sibling"><span class="post-siblings__direction">More?</span> <a class="tag-link-link" href="/">All articles ever</a> <a class="tag-link-link" href="/tags/open source" rel="tag">open source</a> <a class="tag-link-link" href="/tags/programming" rel="tag">programming</a> <a class="tag-link-link" href="/tags/javascript" rel="tag">javascript</a> <a class="tag-link-link" href="/tags/developer experience" rel="tag">developer experience</a></div><a class="link--bare post-sibling" href="/2021/09/21/useeffect-derived-state/"><span class="post-siblings__direction">Older?</span> <span class="link__text">useLayoutEffect is a bad place for deriving state</span> </a><a class="link--bare post-sibling" href="/2021/09/24/quick-size-check/"><span class="post-siblings__direction">Newer?</span> <span class="link__text">Zero-setup bundle size checker</span></a></div></article><script async src="/js/share.js"></script></div></body></html>
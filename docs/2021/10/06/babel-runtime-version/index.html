<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="yandex-verification" content="635edef3908320be"><meta name="google-site-verification" content="5nfOA5k_QcuAP9zbAASIV24DlAZG7BWxRVYoNlKCAoc"><meta name="color-scheme" content="dark light"><meta property="og:type" content="article"><meta property="og:title" content="Is your babel&#39;s transform-runtime getting lazy? You better check."><meta property="og:url" content="https://thoughtspile.github.io/2021/10/06/babel-runtime-version/"><meta property="og:site_name" content="Vladimir Klepov as a Coder"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://thoughtspile.github.io/images/sherlock.jpg"><meta property="article:published_time" content="2021-10-06T00:00:00.000Z"><meta property="article:author" content="Vladimir Klepov"><meta property="article:tag" content="babel"><meta property="article:tag" content="javascript"><meta property="article:tag" content="infra"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@thoughtspile"><meta name="twitter:image" content="https://thoughtspile.github.io/images/sherlock.jpg"><title>Is your babel&#39;s transform-runtime getting lazy? You better check.</title><link rel="stylesheet" href="/css/style.css?ts=1708189105370"><link rel="canonical" href="https://thoughtspile.github.io/2021/10/06/babel-runtime-version/"><link rel="alternate" href="/atom.xml" title="Vladimir Klepov as a Coder" type="application/atom+xml"><script defer="defer" data-domain="thoughtspile.github.io" src="https://t.thoughtspile.tech/js/script.js"></script></head><body class="max-width mx-auto px3"><div class="content index"><a href="/" id="header" class="header header--post"><div id="logo"></div><header id="title"><h1>Vladimir Klepov as a Coder</h1></header></a><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Is your babel&#39;s transform-runtime getting lazy? You better check.</h1><div class="post__date">Written in <time>2021</time></div></header><div class="content" itemprop="articleBody"><p>IE11 is not dead yet, and our library is supposed to run there and make russian grandmas happy. As you can guess, we rely on babel's <a href="https://babeljs.io/docs/en/babel-preset-env" target="_blank" rel="noopener">preset-env</a> a lot. We also don't want our code to be 55% babel helpers, so we use babel's <a href="https://babeljs.io/docs/en/babel-plugin-transform-runtime" target="_blank" rel="noopener">transform-runtime</a> — it should make babel <code>import someHelper from '@babel/runtime/some-helper'</code> instead of inlining it into every file. After making some build chain updates I went to see if the transpiled version was OK. And guess what I noticed? Some babel helpers were still there, inlined:</p><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> _defineProperty <span class="token keyword">from</span> <span class="token string">"@babel/runtime/helpers/defineProperty"</span><span class="token punctuation">;</span><br><span class="token comment">// go away transform do you have any idea who I am?</span><br><span class="token keyword">function</span> <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> enumerableOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* blah-blah-blah */</span> <span class="token punctuation">}</span><br><span class="token keyword">function</span> <span class="token function">_objectSpread</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* more blah-blah-blah */</span> <span class="token punctuation">}</span><br><br><span class="token keyword">var</span> <span class="token function-variable function">copy</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">_objectSpread</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>WTF? I want to <code>import _objectSpread</code>, you lazy code! What's wrong with you? A leak from an external library? An unexpected interaction with <code>preset-react</code> or <code>preset-typescript</code>? Corrupt installation? Babel bugs? No, no, no, no.</p><p><img src="/images/sherlock.jpg" alt=""></p><p>The answer was simple — transform-runtime wants me to tell it what <code>@babel/runtime</code> version I have via <a href="%60@babel/runtime%60">the <code>version</code> option</a>. For some reason, transform-runtime assumes you have <code>@babel/runtime</code> version <code>7.0.0</code>, and if a helper was not in <code>runtime@7.0.0</code>, it won't bother importing it. Babel is at <code>7.15.x</code> now, and a lot has changed. Anyways, if you pass the real runtime version you installed:</p><pre class="language-js"><code class="language-js">exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token string-property property">"plugins"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">[</span><span class="token string">"@babel/plugin-transform-runtime"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>      <span class="token comment">// this is the magic line</span><br>      <span class="token string-property property">"version"</span><span class="token operator">:</span> <span class="token string">"7.15.0"</span><br>    <span class="token punctuation">}</span><span class="token punctuation">]</span><br>  <span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre><p><code>transform-runtime</code> will finally do its job as it should:</p><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> _objectSpread <span class="token keyword">from</span> <span class="token string">"@babel/runtime/helpers/objectSpread2"</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> copy <span class="token operator">=</span> <span class="token function">_objectSpread</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>If you'd rather do it once, use <code>babel.config.js</code> and read the runtime version from <code>package.json</code> — both your dependency range and the version in node_modules work fine, though I feel the latter is cleaner:</p><pre class="language-js"><code class="language-js"><span class="token comment">// in babel.config.js</span><br><span class="token keyword">const</span> requiredVersion <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dependencies<span class="token punctuation">[</span><span class="token string">'@babel/runtime'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> installedVersion <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/runtime/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">;</span></code></pre><hr><p>If you want your <code>@babel/plugin-transform-runtime</code> not to get lazy and really deduplicate all the helpers, set transform-runtime's <code>version</code> option to the current <code>@babel/runtime</code> version. Also keep your babel stack updated, and try to match <code>@babel/*</code> versions. You're welcome.</p></div><span class="share"><div><a href="https://twitter.com/share?url=https://thoughtspile.github.io/2021/10/06/babel-runtime-version/&text=Is your babel&#39;s transform-runtime getting lazy? You better check. by @thoughtspile" target="_blank" rel="noopener">Tweet</a></div><div id="share-button"><a>Share</a></div></span><div class="social-links"><a href="https://www.linkedin.com/in/vklepov/" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a href="https://github.com/thoughtspile" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a href="/atom.xml" class="link--bare" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="rss" class="svg-inline--fa fa-rss fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8 0 416 186.2 416 416c0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96C14.3 96 0 81.7 0 64zM128 416c0 35.3-28.7 64-64 64s-64-28.7-64-64s28.7-64 64-64s64 28.7 64 64zM32 160c159.1 0 288 128.9 288 288c0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224c-17.7 0-32-14.3-32-32s14.3-32 32-32z"></path></svg></a></div><a href="https://buymeacoffee.com/thoughtspile" class="link--bare bmc-card" target="_blank" rel="noopener"><div><b>Hello, friend!</b> My name is Vladimir, and I love writing about web development. If you got down here, you probably enjoyed this article. My goal is to become an independent content creator, and you'll help me get there by <span class="bmc">buying me a coffee!</span></div><img src="/images/bmc.png" data-no-preview class="bmc-image"></a><div class="post-related"><div class="post-sibling"><span class="post-siblings__direction">More?</span> <a class="tag-link-link" href="/">All articles ever</a> <a class="tag-link-link" href="/tags/babel" rel="tag">babel</a> <a class="tag-link-link" href="/tags/javascript" rel="tag">javascript</a> <a class="tag-link-link" href="/tags/infra" rel="tag">infra</a></div><a class="link--bare post-sibling" href="/2021/10/04/react-context-dangers/"><span class="post-siblings__direction">Older?</span> <span class="link__text">How to destroy your app performance using React contexts</span> </a><a class="link--bare post-sibling" href="/2021/10/11/usestate-object-vs-multiple/"><span class="post-siblings__direction">Newer?</span> <span class="link__text">Are many useStates better than useState(object)?</span></a></div></article><script async src="/js/share.js"></script></div></body></html>
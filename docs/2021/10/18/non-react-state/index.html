<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="yandex-verification" content="635edef3908320be"><meta name="google-site-verification" content="5nfOA5k_QcuAP9zbAASIV24DlAZG7BWxRVYoNlKCAoc"><meta name="color-scheme" content="dark light"><meta property="og:type" content="article"><meta property="og:title" content="How to replace useState with useRef and be a winner"><meta property="og:url" content="https://thoughtspile.github.io/2021/10/18/non-react-state/"><meta property="og:site_name" content="Vladimir Klepov as a Coder"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://thoughtspile.github.io/images/states.png"><meta property="article:published_time" content="2021-10-18T00:00:00.000Z"><meta property="article:author" content="Vladimir Klepov"><meta property="article:tag" content="react"><meta property="article:tag" content="javascript"><meta property="article:tag" content="hooks"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@thoughtspile"><meta name="twitter:image" content="https://thoughtspile.github.io/images/states.png"><title>How to replace useState with useRef and be a winner</title><link rel="stylesheet" href="/css/style.css?ts=1715245757419"><link rel="canonical" href="https://thoughtspile.github.io/2021/10/18/non-react-state/"><link rel="alternate" href="/atom.xml" title="Vladimir Klepov as a Coder" type="application/atom+xml"><script defer="defer" data-domain="thoughtspile.github.io" src="https://t.thoughtspile.tech/js/script.js"></script></head><body class="max-width mx-auto px3"><div class="content index"><a href="/" id="header" class="header header--post"><div id="logo"></div><header id="title"><h1>Vladimir Klepov as a Coder</h1></header></a><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">How to replace useState with useRef and be a winner</h1><div class="post__date">Written in <time>2021</time></div></header><div class="content" itemprop="articleBody"><p>React state is the bread and butter of a react app — it's what makes your app dynamic. React state lives in <code>useState</code>, <code>useReducer</code> or in <code>this.state</code> of a class component, and changing it updates your app. But then there's a vast ocean of state not managed by React. This includes <code>ref.current</code>, object properties, and, really, anything other than react state.</p><p>React state is a safe default — if you put a dynamic value somewhere else, the component won't re-render. But stuffing values that don't <em>need</em> to be managed by react into state is more sneaky. It rarely results in visible bugs, but makes your components more complex and slows them down.</p><p>In this post, we'll:</p><ul><li>Discuss the difference between react state and non-react state;</li><li>See when state can be safely replaced with a ref (spoiler: you only <em>need</em> state if your JSX depends on it, or to trigger <code>use*Effect</code>);</li><li>Learn a few optimizations for performance-critical cases.</li></ul><p><img src="/images/states.png" alt=""></p><h2>What are we even talking about?</h2><p>Let's first spend a minute reflecting on what's so special about react state, and what types of non-react state exist, and how they're so different, but still useful.</p><p>Describing react state is easy: it's a value stored in <code>useState</code> hook (or <code>useReducer</code>, since <a href="/2021/09/27/usestate-tricks/">they are the same</a>) or in <code>this.state</code> of a class component. Updating react state makes your component re-render. In fact, updating react state is the <em>only</em> thing that makes react re-render. React veterans recall <code>forceUpdate</code>, but it can be <a href="https://stackoverflow.com/a/53215514" target="_blank" rel="noopener">trivially emulated with a setState</a>. <code>ReactDOM.render</code> makes your app <em>render,</em> not <em>re</em>-render. So, react state is what makes react tick.</p><p>Now, let's see where else in our app a state can live. &quot;Anywhere else&quot; is correct, but too vague — let's make a list of common locations:</p><ol><li><code>useRef().current</code>.</li><li>Class properties of class components, fashionable or not.</li><li>Actually, every property of every object ever.</li><li>Yes, that includes state managers. Their state only turns into react state after a couple of magic tricks.</li><li>DOM state — input values, focus, scrolls, any DOM tree elements and attributes not managed by React. Making them <em>controlled</em> does not literally turn them into react state, it's just another trick.</li><li>Values of variables. You may have never thought of these as &quot;state&quot;, but hey — that's a value lying in memory that closures can read, so it qualifies.</li></ol><p>This list could go on: other stateful browser APIs (think pending timeouts), back-end state, the photons in the transatlantic cables carrying our API data, your user's neural signals, and all his lifetime experience, and that tree in the forest that fell while no one was watching, all came together just for the user to click the button you're building now. Does free will exist? Are we mere grains of sand carried by the flow of creation? Oh no, Vladimir, you've done it again, let's get back on track, shall we? There are more pressing and practical matters we need to discuss today.</p><h2>When to use react state</h2><p>React depends on state to make your app dynamic. That is the core functionality of a front-end framework, so you'd expect an infinite variety of use cases to exist. But in fact, there are only two situations when you <em>must</em> use react state, and they are easy to spot.</p><p>Every dynamic value that affects your component's DOM is react state. Fair enough, the UI should stay up-to-date. Quick example, no revelations here:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Incrementer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setValue</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>      Clicked </span><span class="token punctuation">{</span>value<span class="token punctuation">}</span><span class="token plain-text"> times<br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>But values that have no effect on the vDOM can still belong in react state. Why? To trigger an effect:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">TitleRandomizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>title<span class="token punctuation">,</span> setTitle<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> title<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>title<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">''</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>      randomize page title<br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>This is not exclusive to hooks — <code>componentDidUpdate</code> is no different, since it's only called when a component, you know, <em>did update:</em></p><pre class="language-jsx"><code class="language-jsx"><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>title<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Believe it or not, that's it: use react state for values that (a) are used in the JSX <em>or</em> (b) trigger side-effects via <code>use*Effect</code> or in lifecycle hooks. In all other cases, you can safely store them anywhere you want.</p><h2>When not to use React state</h2><p>Is there anything wrong with react state? You'd much prefer your app to update, not to stay jammed in a stale state. It's a fine feature, but <em>not</em> using react state has some hard (and some soft) advantages.</p><p>First, non-react state is easier to work with. Updates to non-react state are synchronous — no need to put stuff that reads an updated value into effects or that nasty <code>this.setState</code> callback. You also get to utilize mutable data containers and assign them directly without <a href="https://github.com/immerjs/immer" target="_blank" rel="noopener">immer</a> or <a href="https://mobx.js.org/" target="_blank" rel="noopener">mobx</a> — I know you've secretly missed it.</p><pre class="language-jsx"><code class="language-jsx"><span class="token comment">// We've come to accept this</span><br><span class="token function">setChecked</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>checked<span class="token punctuation">,</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// But isn't this just nicer?</span><br>checked<span class="token punctuation">[</span>value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code></pre><p>Secondly, updating a non-react state doesn't trigger a re-render. You can see it as a footgun, or you can use it to your advantage. The lack of rendering enables very powerful performance optimizations — see hard rule of performance #1/1: doing nothing is <em>not slower</em> than doing something. Also, since refs are constant-reference mutable objects, you don't have to recreate callbacks that rely on them, and can thus skip re-rendering memo-children:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> onCheck <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// re-render, including children</span><br>  <span class="token function">setChecked</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>checked<span class="token punctuation">,</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>checked<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> onCheckRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// relax, react, nothing happened</span><br>  checked<span class="token punctuation">[</span>value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>current<span class="token punctuation">;</span></code></pre><p>Not using react state helps avoid a problem I call <em>render thrashing</em> — a react equivalent of <a href="https://www.afasterweb.com/2015/10/05/how-to-thrash-your-layout/" target="_blank" rel="noopener">layout thrashing.</a> That's when a state change triggers an effect that changes more state, and react must keep re-rendering until the state stabilizes. If timed correctly, ref updates are very effective at avoiding this pitfall.</p><p>Finally, react state carries more semantics, and overusing it makes your app seem more complex. State is a big deal in react. Touching state has consequences — it triggers DOM changes and funny side-effects. When changing a non-state, you just change it, and maybe later someone can read it back. Not so scary!</p><p>One <em>caveat</em> pointed out by <a href="https://twitter.com/phry" target="_blank" rel="noopener">Lenz Weber:</a> accessing <code>ref.current</code> in the render phase is not concurrent-mode-safe, and <a href="https://github.com/facebook/react/pull/18545" target="_blank" rel="noopener">may cause a warning</a> in a future react version. Setting state while rendering seems to work. At any rate, firing side-effects from a render function is not healthy.</p><p>Now, let's move on to some concrete examples where replacing state with a ref is useful.</p><h3>Values you only need in callbacks</h3><p>You don't need react state if you only use it in callbacks — event handlers or effects. To demonstrate this, let's build a simple swipe detector. The user puts a finger on the screen and moves it left or right. Sticking to react state, we end up with:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Swiper</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> prev<span class="token punctuation">,</span> next<span class="token punctuation">,</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>startX<span class="token punctuation">,</span> setStartX<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">detectSwipe</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clientX <span class="token operator">></span> startX <span class="token operator">?</span> <span class="token function">prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><br>    <span class="token attr-name">onTouchStart</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token operator">=></span> <span class="token function">setStartX</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clientX<span class="token punctuation">)</span><span class="token punctuation">}</span></span><br>    <span class="token attr-name">onTouchEnd</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>detectSwipe<span class="token punctuation">}</span></span><br>  <span class="token punctuation">></span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p><code>startX</code> does not affect the DOM or fire any effects, we only store it to read later in a <code>touchend</code>. Still, you get a useless render on <code>touchstart</code>. Let's try again with a ref:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Swiper</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> prev<span class="token punctuation">,</span> next<span class="token punctuation">,</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> startX <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">detectSwipe</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clientX <span class="token operator">></span> startX<span class="token punctuation">.</span>current <span class="token operator">?</span> <span class="token function">prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><br>    <span class="token attr-name">onTouchStart</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token operator">=></span> startX<span class="token punctuation">.</span>current <span class="token operator">=</span> e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clientX<span class="token punctuation">}</span></span><br>    <span class="token attr-name">onTouchEnd</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>detectSwipe<span class="token punctuation">}</span></span><br>  <span class="token punctuation">></span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Voila, Swiper now doesn't have to re-render on <code>touchstart</code>. Additionally, <code>detectSwipe</code> now doesn't depend on the changing <code>startX</code> reference, so you can <code>useCallback(..., [])</code> on it. Awesome!</p><p>By the way, the tradition of storing DOM nodes in a ref is a special case of this rule — it works because you only access the node in callbacks.</p><h3>Buffering state updates</h3><p>OK, one render is <em>nothing</em> for react. Let's up the stakes by bringing in a whole rerendering barrage. Now the user can move the <code>Swiper</code> content around with the power of his finger:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Swiper</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> startX <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>offset<span class="token punctuation">,</span> setOffset<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">onStart</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    startX<span class="token punctuation">.</span>current <span class="token operator">=</span> e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clientX<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">trackMove</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">setOffset</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clientX <span class="token operator">-</span> startX<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><br>    <span class="token attr-name">onTouchStart</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onStart<span class="token punctuation">}</span></span><br>    <span class="token attr-name">onTouchMove</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>trackMove<span class="token punctuation">}</span></span><br>  <span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate3d(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px,0,0)</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>      </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"><br>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>It works, but note how <code>touchMove</code> updates state and makes the component re-render. <code>touchMove</code> event is famous for firing <em>a lot</em> — I ended up with <a href="https://codesandbox.io/s/objective-lederberg-zjft4" target="_blank" rel="noopener">4–5 renders per frame.</a> The user only sees the result of the last render before paint, the other 4 are wasted. <code>requestAnimationFrame</code> is a perfect fit for this case — we remember the swipe position in a ref, but only update the state once per frame:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> pendingFlush <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token function-variable function">trackMove</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>startX<span class="token punctuation">.</span>current <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">cancelAnimationFrame</span><span class="token punctuation">(</span>pendingFlush<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    pendingFlush<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token function">setOffset</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>clientX <span class="token operator">-</span> startX<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>Here's an alternate take. Instead of canceling the pending RAF, we can let them all fire, but set state to the same value — <a href="/2021/09/27/usestate-tricks/">only one will cause a re-render:</a></p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> pendingOffset <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token function-variable function">trackMove</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>startX<span class="token punctuation">.</span>current <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    pendingOffset<span class="token punctuation">.</span>current <span class="token operator">=</span> e<span class="token punctuation">.</span>clientX <span class="token operator">-</span> startX<span class="token punctuation">.</span>current<span class="token punctuation">;</span><br>    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token function">setOffset</span><span class="token punctuation">(</span>pendingOffset<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>We've just implemented a custom update batching mechanism by making state and ref work together. The mutable ref acts as a <em>staging area</em> for pending state updates. Just like the last time, <code>trackMove</code> only depends on stable refs, and can be turned into a const-reference callback.</p><h3>State that you want to manage yourself</h3><p>When the user moves his finger, we let react determine the current offset and update the <code>style</code> accordingly. React may be fast, but it doesn't know that <code>trackMove</code> just changes the transform, and has to do a lot of guessing — call your render, generate the vDOM, diff it, and then, a-ha, it seems like we just have to update a transform. But <em>you</em> know what you're up to, and can save React all that trouble by just doing it yourself:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Swiper</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> startX <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> transformEl <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">onStart</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    startX<span class="token punctuation">.</span>current <span class="token operator">=</span> e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clientX<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">trackMove</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> offset <span class="token operator">=</span> e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clientX <span class="token operator">-</span> startX<span class="token punctuation">.</span>current<span class="token punctuation">;</span><br>    transformEl<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate3d(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px,0,0)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><br>    <span class="token attr-name">onTouchStart</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onStart<span class="token punctuation">}</span></span><br>    <span class="token attr-name">onTouchMove</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>trackMove<span class="token punctuation">}</span></span><br>  <span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>transformEl<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>      </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"><br>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Voila, 0 renders! Fair warning — it's very easy to trick yourself here, especially if several things can affect the DOM. Reserve this technique for frequent low-level stuff like animations and gestures — it can make a huge difference.</p><h3>Derived state</h3><p>If a value always updates <em>together</em> with a react state item, we can piggyback on that re-render and update something else that is not react state along the way. This can be very clean — remember how I said <em>any</em> variable holds a state?</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> isValid <span class="token operator">=</span> value <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span></code></pre><p>This can be trickier and involve a ref, but still straightforward on the outside, as <code>useMemo</code> — yes, it <a href="/2021/04/05/useref-usememo/">does use a ref</a> deep inside:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>search<span class="token punctuation">,</span> setSearch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> matches <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> options<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">op</span> <span class="token operator">=></span> op<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>options<span class="token punctuation">,</span> search<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>In both cases, we're using non-react state, carefully synchronizing its updates with the master state. Much better than cascading state updates:</p><pre class="language-jsx"><code class="language-jsx"><span class="token comment">// un-example</span><br><span class="token keyword">const</span> <span class="token punctuation">[</span>search<span class="token punctuation">,</span> setSearch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token punctuation">[</span>matches<span class="token punctuation">,</span> setMatches<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// now we re-render twice per search change</span><br>  <span class="token function">setMatches</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">op</span> <span class="token operator">=></span> op<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>options<span class="token punctuation">,</span> search<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><hr><p>Wow, it's been a long post. Now we need a multi-part recap:</p><ul><li>State in a react app can be either a react state (<code>this.state</code>, <code>useState</code>, <code>useReducer</code>) or non-react state (<code>ref.current</code>, object properties, variable values, or anything else).</li><li>Only updates to react state make react re-render, so you <em>must</em> used it when the vDOM depends on it, or to trigger a <code>use*Effect</code>.</li></ul><p>Not using state has some advantages:</p><ul><li>Fewer renders</li><li>More stable callbacks</li><li>No cascading state updates aka <em>render thrashing</em></li><li>Synchronously mutating data is so nice</li><li>Overusing state makes a component seem complex</li></ul><p>Here are 4 powerful optimizations relying on non-react state:</p><ul><li>If a value is only used in callbacks – make it a ref (includes DOM refs).</li><li>A ref can be a buffer for pending state updates.</li><li>Use refs if you feel you can update the DOM yourself without involving react.</li><li>Derived state also relies on refs, carefully updated on core state changes.</li></ul><p>As a rule of thumb, refs are fine as long as you don't use their current value in render.</p><p>State vs non-state is a very powerful concept that I'll revisit in my future posts. As a homework, try thinking about how React's only job is actually synchronizing its state to the external DOM state. Or that state-of-the-univerese thing I talked about earlier. See you soon!</p></div><span class="share"><div><a href="https://twitter.com/share?url=https://thoughtspile.github.io/2021/10/18/non-react-state/&text=How to replace useState with useRef and be a winner by @thoughtspile" target="_blank" rel="noopener">Tweet</a></div><div id="share-button"><a>Share</a></div></span><div class="social-links"><a href="https://www.linkedin.com/in/vklepov/" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a href="https://github.com/thoughtspile" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a href="/atom.xml" class="link--bare" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="rss" class="svg-inline--fa fa-rss fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8 0 416 186.2 416 416c0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96C14.3 96 0 81.7 0 64zM128 416c0 35.3-28.7 64-64 64s-64-28.7-64-64s28.7-64 64-64s64 28.7 64 64zM32 160c159.1 0 288 128.9 288 288c0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224c-17.7 0-32-14.3-32-32s14.3-32 32-32z"></path></svg></a></div><a href="https://buymeacoffee.com/thoughtspile" class="link--bare bmc-card" target="_blank" rel="noopener"><div><b>Hello, friend!</b> My name is Vladimir, and I love writing about web development. If you got down here, you probably enjoyed this article. My goal is to become an independent content creator, and you'll help me get there by <span class="bmc">buying me a coffee!</span></div><img src="/images/bmc.png" data-no-preview class="bmc-image"></a><div class="post-related"><div class="post-sibling"><span class="post-siblings__direction">More?</span> <a class="tag-link-link" href="/">All articles ever</a> <a class="tag-link-link" href="/tags/react" rel="tag">react</a> <a class="tag-link-link" href="/tags/javascript" rel="tag">javascript</a> <a class="tag-link-link" href="/tags/hooks" rel="tag">hooks</a></div><a class="link--bare post-sibling" href="/2021/10/13/really-declarative/"><span class="post-siblings__direction">Older?</span> <span class="link__text">Thanks React, I'm fine with an imperative setInterval</span> </a><a class="link--bare post-sibling" href="/2021/10/25/useref-no-current/"><span class="post-siblings__direction">Newer?</span> <span class="link__text">Can we useRef, but without the .current? Let's try!</span></a></div></article><script async src="/js/share.js"></script></div></body></html>
<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="yandex-verification" content="635edef3908320be"><meta name="google-site-verification" content="1-m0w7Up8df1sn0230jxfTKKZ4jLeln_Em1tcyfU0qw"><meta name="color-scheme" content="dark light"><meta property="og:type" content="article"><meta property="og:title" content="How we made our pre-commit check 7x faster"><meta property="og:url" content="https://blog.thoughtspile.tech/2021/06/14/faster-pre-commit/"><meta property="og:site_name" content="Vladimir Klepov as a Coder"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.thoughtspile.tech/images/bmc.png"><meta property="article:published_time" content="2021-06-14T00:00:00.000Z"><meta property="article:author" content="Vladimir Klepov"><meta property="article:tag" content="infra"><meta property="article:tag" content="programming"><meta property="article:tag" content="javascript"><meta property="article:tag" content="typescript"><meta property="article:tag" content="eslint"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@thoughtspile"><meta name="twitter:image" content="https://blog.thoughtspile.tech/images/bmc.png"><title>How we made our pre-commit check 7x faster</title><link rel="stylesheet" href="/css/style.css?ts=1675547910288"><link rel="canonical" href="https://blog.thoughtspile.tech/2021/06/14/faster-pre-commit/"><link rel="alternate" href="/atom.xml" title="Vladimir Klepov as a Coder" type="application/atom+xml"><script defer="defer" data-domain="blog.thoughtspile.tech" src="https://t.thoughtspile.tech/js/script.js"></script></head><body class="max-width mx-auto px3"><div class="content index"><a href="/" id="header" class="header header--post"><div id="logo"></div><header id="title"><h1>Vladimir Klepov as a Coder</h1></header></a><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">How we made our pre-commit check 7x faster</h1><div class="post__date">Written in <time>2021</time></div></header><div class="content" itemprop="articleBody"><p>As a guy who's somewhat responsible for a large chunk of front-end development infrastructure at our company, I've spent the last couple of months woried about the performance of our pre-commit checks. We have around 50 projects on a standard react + typescript stack, and a corresponding set of pre-commit checks: <code>eslint</code> + <code>stylelint</code> + <code>tsc</code> + sometimes, <code>jest</code>. This suite was taking anywhere from 10s on a starter project to 50s on a monstrous app — not fun. I set out to fix this — and I did.</p><h2>Cache your linters</h2><p>The quick fix was to add <code>--cache</code> flag to <a href="https://eslint.org/docs/user-guide/command-line-interface#options" target="_blank" rel="noopener">eslint</a> and <a href="https://stylelint.io/user-guide/usage/options/#cache" target="_blank" rel="noopener">stylelint</a> calls. These tools process one file at a time, and caching makes them run very fast (around 1s for a normal commit instead of 10+). A quick <a href="https://github.com/search?l=JSON&amp;q=eslint+src&amp;type=Code" target="_blank" rel="noopener">github search</a> makes me sad, because few people seem to do this. Also don't forget to gitignore <code>.stylelintcache</code> and <code>.eslintcache</code>. <strong>Gain:</strong> 50 -&gt; 30s.</p><h2>Run the checks concurrently</h2><p>Most checks were written like <code>eslint src &amp;&amp; stylelint src/**/*.css &amp;&amp; tsc --noEmit</code> — I assume the code was just being copied over. It's a waste for multi-core developer machines, and has an extra drawback of being unusable on windows (I don't think many front-end devs run windows, anyways). Making the checks run in parallel using <a href="https://github.com/kimmobrunfeldt/concurrently" target="_blank" rel="noopener"><code>concurrently</code></a> or <a href="https://github.com/mysticatea/npm-run-all/blob/master/docs/npm-run-all.md" target="_blank" rel="noopener"><code>npm-run-all</code></a> essentially makes the check run as fast as the slowest check — in our case, we were getting linters and jest for free, and <code>tsc</code> became the limiting factor. <strong>Gain:</strong> 30 -&gt; 28s.</p><h2>Cache tsc</h2><p><a href="https://www.typescriptlang.org/tsconfig/#noEmit" target="_blank" rel="noopener"><code>tsc --noEmit</code></a> sounds like the way to go if you run <code>tsc</code> to type-check your code, not to build anything. However, it was impossible to combine <code>--noEmit</code> with <code>--incremental</code> for a long time, leaving you with no caching and slow builds. Luckily, <a href="https://devblogs.microsoft.com/typescript/announcing-typescript-4-0-beta/#noemit-and-incremental" target="_blank" rel="noopener">TS 4.0+ supports</a> this combination — just drop an <code>--incremental</code> flag and save time. If you're not ready to upgrade, <a href="https://stackoverflow.com/a/62622318" target="_blank" rel="noopener">a workaround</a> exists — you want the check to be faster, not to write exactly zero files, don't you? <strong>Gain:</strong> 28 -&gt; 7s.</p><h2>Do not break jest dependency detection</h2><p>Lastly, I wanted to cover several ways to speed up <a href="https://jestjs.io/" target="_blank" rel="noopener">jest</a> if you happen to run it in your pre-commit (this is pretty rare). Obviously, you want to use <a href="https://jestjs.io/docs/cli#--onlychanged" target="_blank" rel="noopener"><code>jest --onlyChanged</code></a> (or <code>jest -o</code>) to test only the files changed in the commit, not all the project. <code>jest</code> uses simple file-based dependency detection, no tree-shaking or anything — if you change file A, all the files that <code>import A</code> may have changed, and so on, and jest must run the tests for all the files that depend on A, too. You can work with this if you follow 2 rules:</p><ol><li>Do no import <code>index.js</code> inside your project — this erases granular change checks for individual modules re-exported via index. In the worst case, if you import from a root-level index, <em>every</em> change triggers all the tests.</li><li>Break frequently changed files into smaller chunks. Granted, it's good to use smaller modules in any case, but I bet you could start with your <code>utils.js</code> that contains 200 helpers. This will allow jest to make better guesses about what actually changed.</li></ol><hr><p>When pre-commit checks get slower, I see a lot of pressure to drop some checks and move them to CI. If you stick with slow checks instead, rest assured many developers will just <code>--no-verify</code> when commiting, which is probably not what you wanted to achieve. Lukily, you can easily make your pre-commit checks run in under 10 seconds:</p><ol><li>Use <code>eslint --cache</code> and <code>stylelint --cache</code></li><li>Run <code>tsc</code> with <code>--incremental</code> flag, or use a <a href="https://stackoverflow.com/a/62622318" target="_blank" rel="noopener">workaround</a> for TS &lt;4.0</li><li>Parallelize the checks using <code>concurrently</code> or <code>npm-run-all</code></li><li>Use <code>jest -o</code>, don't <code>import index</code>, and use smaller modules.</li></ol><p>This can be done in 15 minutes, really. I've run some calculations for you — if you manage to strip 30s off your check time, assuming you make 5 commits a day and have a 3-person team (all this sound plausible), you're saving your team <code>3 * 5 * 0.5 * 250 / 60</code> = 31 hours a year, that's almost a week to spend better than waiting for pre-commit cheks. I really really hope you go and see if you can apply some of these techniques right now.</p></div><span class="share"><div><a href="https://twitter.com/share?url=https://blog.thoughtspile.tech/2021/06/14/faster-pre-commit/&text=How we made our pre-commit check 7x faster by @thoughtspile" target="_blank" rel="noopener">Tweet</a></div><div id="share-button"><a>Share</a></div><div><a href="https://twitter.com/search?q=https://blog.thoughtspile.tech/2021/06/14/faster-pre-commit/" target="_blank" rel="noopener">Discuss on Twitter</a></div></span><div class="social-links"><a href="https://twitter.com/thoughtspile" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://mastodon.online/@thoughtspile" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg></a><a href="https://www.linkedin.com/in/vklepov/" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a href="/atom.xml" class="link--bare" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="rss" class="svg-inline--fa fa-rss fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8 0 416 186.2 416 416c0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96C14.3 96 0 81.7 0 64zM128 416c0 35.3-28.7 64-64 64s-64-28.7-64-64s28.7-64 64-64s64 28.7 64 64zM32 160c159.1 0 288 128.9 288 288c0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224c-17.7 0-32-14.3-32-32s14.3-32 32-32z"></path></svg></a></div><a href="https://buymeacoffee.com/thoughtspile" class="link--bare bmc-card" target="_blank" rel="noopener"><div><b>Hello, friend!</b> My name is Vladimir, and I love writing about web development. If you got down here, you probably enjoyed this article. My goal is to become an independent content creator, and you'll help me get there by <span class="bmc">buying me a coffee!</span></div><img src="/images/bmc.png" class="bmc-image"></a><div class="post-related"><div class="post-sibling"><span class="post-siblings__direction">More?</span> <a class="tag-link-link" href="/">All articles ever</a> <a class="tag-link-link" href="/tags/infra" rel="tag">infra</a> <a class="tag-link-link" href="/tags/programming" rel="tag">programming</a> <a class="tag-link-link" href="/tags/javascript" rel="tag">javascript</a> <a class="tag-link-link" href="/tags/typescript" rel="tag">typescript</a> <a class="tag-link-link" href="/tags/eslint" rel="tag">eslint</a></div><a class="link--bare post-sibling" href="/2021/06/11/cleaner-dynamic-arrays/"><span class="post-siblings__direction">Older?</span> <span class="link__text">Cleaner ways to build dynamic JS arrays</span> </a><a class="link--bare post-sibling" href="/2021/09/21/useeffect-derived-state/"><span class="post-siblings__direction">Newer?</span> <span class="link__text">useLayoutEffect is a bad place for deriving state</span></a></div></article><script async src="/js/share.js"></script></div></body></html>
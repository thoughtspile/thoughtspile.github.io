<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="yandex-verification" content="635edef3908320be"><meta name="google-site-verification" content="1-m0w7Up8df1sn0230jxfTKKZ4jLeln_Em1tcyfU0qw"><meta name="color-scheme" content="dark light"><meta property="og:type" content="article"><meta property="og:title" content="Svelte stores: the curious parts"><meta property="og:url" content="https://blog.thoughtspile.tech/2023/04/22/svelte-stores/"><meta property="og:site_name" content="Vladimir Klepov as a Coder"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.thoughtspile.tech/images/svlete-stores.png?invert"><meta property="article:published_time" content="2023-04-22T00:00:00.000Z"><meta property="article:author" content="Vladimir Klepov"><meta property="article:tag" content="svelte"><meta property="article:tag" content="programming"><meta property="article:tag" content="javascript"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@thoughtspile"><meta name="twitter:image" content="https://blog.thoughtspile.tech/images/svlete-stores.png?invert"><title>Svelte stores: the curious parts</title><link rel="stylesheet" href="/css/style.css?ts=1704542065637"><link rel="canonical" href="https://blog.thoughtspile.tech/2023/04/22/svelte-stores/"><link rel="alternate" href="/atom.xml" title="Vladimir Klepov as a Coder" type="application/atom+xml"><script defer="defer" data-domain="blog.thoughtspile.tech" src="https://t.thoughtspile.tech/js/script.js"></script></head><body class="max-width mx-auto px3"><div class="content index"><a href="/" id="header" class="header header--post"><div id="logo"></div><header id="title"><h1>Vladimir Klepov as a Coder</h1></header></a><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Svelte stores: the curious parts</h1><div class="post__date">Written in <time>2023</time></div></header><div class="content" itemprop="articleBody"><p>We've already <a href="https://blog.thoughtspile.tech/2023/04/22/svelte-state/" target="_blank" rel="noopener">learnt a lot about svelte's reactivity system</a> — the primary way to work with state in svelte components. But not all state belongs in components — sometimes we want app-global state (think state manager), sometimes we just want to reuse logic between components. React has <a href="https://react.dev/reference/react" target="_blank" rel="noopener">hooks,</a> Vue has <a href="https://vuejs.org/guide/reusability/composables.html" target="_blank" rel="noopener">composables</a>. For svelte, the problem is even harder — reactive state <em>only</em> works inside component files, so the rest is handled by a completely separate mechanism — stores. The <a href="https://svelte.dev/tutorial/writable-stores" target="_blank" rel="noopener">tutorial</a> does a decent job of covering the common use cases, but I still had questions:</p><ol><li>What's the relationship between the stores? Are they built on some common base?</li><li>Is it safe to use <code>{ set } = store</code> as a free function?</li><li>How does <code>get(store)</code> receive the current value if it's not exposed on the object?</li><li>Does <code>set()</code> trigger subscribers when setting the current value?</li><li>What's the order of subscriber calls if you <code>set()</code> inside a subscriber?</li><li>Does <code>derived</code> listen to the base stores when it's not observed?</li><li>Will changing two <code>dervied</code> dependencies trigger one or two derived computations?</li><li>Why does <code>subscribe()</code> have a second argument?</li><li>What is <code>$store</code> sytax compiled to?</li></ol><p>In this article, I explore all these questions (and find a few svelte bugs in the process).</p><p><img src="/images/svlete-stores.png?invert" alt=""></p><h2>writable is the mother store</h2><p>Svelte has 3 built-in store types: <code>writable</code>, <code>readable</code>, and <code>derived</code>. However, they are neatly implemented in terms of one another, <a href="https://github.com/sveltejs/svelte/blob/master/src/runtime/store/index.ts" target="_blank" rel="noopener">taking only 236 lines,</a> over half of which is TS types and comments.</p><p>The implementation of <code>readable</code> is remarkably simple — it creates a writable, and only returns its subscribe method. Let me show it <a href="https://github.com/sveltejs/svelte/blob/64b8c8b33c52cdb1ae9ee8b0148809237c5cb997/src/runtime/store/index.ts#L60" target="_blank" rel="noopener">in its entirety:</a></p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">readable</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> start</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token literal-property property">subscribe</span><span class="token operator">:</span> <span class="token function">writable</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">.</span>subscribe<br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Moreover, <code>derived</code> is just <a href="https://github.com/sveltejs/svelte/blob/64b8c8b33c52cdb1ae9ee8b0148809237c5cb997/src/runtime/store/index.ts#L173" target="_blank" rel="noopener">a special way</a> of constructing <code>readable</code>:</p><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">derived</span><span class="token punctuation">(</span><span class="token parameter">stores<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> initial_value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// ...some normalization</span><br>	<span class="token keyword">return</span> <span class="token function">readable</span><span class="token punctuation">(</span>initial_value<span class="token punctuation">,</span> <span class="token comment">/* some complex code */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>While we're at it, note that <code>update</code> method of a writable store is a <a href="https://github.com/sveltejs/svelte/blob/64b8c8b33c52cdb1ae9ee8b0148809237c5cb997/src/runtime/store/index.ts#L94" target="_blank" rel="noopener">very thin wrapper</a> over <code>set</code>: <code>fn =&gt; set(fn(value))</code>.</p><p>All in all:</p><ul><li><code>writable</code> is the OG store,</li><li><code>readable</code> just removes <code>set</code> &amp; <code>update</code> methods from a writable,</li><li><code>derived</code> is just a predefined <code>readable</code> setup,</li><li><code>update</code> is just a wrapper over <code>set</code>.</li></ul><p>This greatly simplifies our analysis — we can just investigate <code>writable</code> arguments, <code>subscribe</code>, and <code>set</code> — and our findings also hold for other store types. Well done, svelte!</p><h2>Store methods don't rely on <code>this</code></h2><p>Writable (and, by extension, readable and derived) is implemented with objects and closures, and does not rely on <code>this</code>, so you can safely pass free methods around without dancing with <code>bind</code>:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> subscribe<span class="token punctuation">,</span> set <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">writable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> toggle <span class="token operator">=</span> <span class="token punctuation">{</span> subscribe<span class="token punctuation">,</span> <span class="token function-variable function">activate</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>However, arbitrary custom stores are not guaranteed to have this trait, so it's best to stay safe working with an unknown store-shaped argument — like <a href="https://github.com/sveltejs/svelte/blob/64b8c8b33c52cdb1ae9ee8b0148809237c5cb997/src/runtime/store/index.ts#L226" target="_blank" rel="noopener">svelte itself</a> does with <code>readonly</code>:</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">return</span> <span class="token punctuation">{</span><br>		<span class="token literal-property property">subscribe</span><span class="token operator">:</span> store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">,</span><br>	<span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2>Subscriber is invoked immediately</h2><p>As svelte stores implement observable value pattern, you'd expect them to have a way to access current value via <code>store.get()</code> or <code>store.value</code> — but it's not there! Instead, you use the special <code>get()</code> helper function:</p><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> get <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'svelte/store'</span><br><span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>But, if the store does not expose a value, how can <code>get(store)</code> synchronously access it? Normally, the subscribers are only called on change, which can occur whenever. Well, svelte <code>subscribe</code> is not your average subscribe — calling <code>subscribe(fn)</code> not only starts listening to changes, but also synchronously calls <code>fn</code> with the current value. <code>get</code> subscribes to the store, extracts the value from this immediate invocation, and immediately unsubscribes — <a href="https://github.com/sveltejs/svelte/blob/64b8c8b33c52cdb1ae9ee8b0148809237c5cb997/src/runtime/internal/utils.ts#L77" target="_blank" rel="noopener">like this:</a></p><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> value<span class="token punctuation">;</span><br><span class="token keyword">const</span> unsub <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=></span> value <span class="token operator">=</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">unsub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The official svelte tutorial <a href="https://svelte.dev/tutorial/custom-stores" target="_blank" rel="noopener">section on custom stores</a> says: <em>as long as an object correctly implements the subscribe method, it's a store.</em> This might bait you into writing &quot;custom stores&quot; with <code>subscribe</code> method, not based off of <code>writable</code>. The trick word here is <em>correctly implements</em> — even based on the tricky <code>subscribe</code> self-invocation it's not an easy feat, so please stick to manipulations with readable / writable / derived.</p><h2>set() is pure for primitives</h2><p><code>writable</code> stores are pure in the same sense as svelte state — <a href="">notifications are skipped</a> when state is primitive, and the next value is equal to the current one:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token function">writable</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// logs 9 because immediate self-invocation</span><br>s<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// does not log</span><br>s<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Object state <a href="https://svelte.dev/repl/eb1a787c9bce4ae8b88f85934d7ec37d?version=3.59.1" target="_blank" rel="noopener">disables this optimization</a> — you can pass a shallow equal object, or the same (by reference) object, the subscribers will be called in any case:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token function">writable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">9</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>s<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// each one logs</span><br>s<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">s</span> <span class="token operator">=></span> s<span class="token punctuation">)</span><span class="token punctuation">;</span><br>s<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">get</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>s<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">9</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>On the bright side, you can mutate the state in update, and it works:</p><pre class="language-js"><code class="language-js">s<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">s</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    s<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> s<br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2>Subscriber consistency</h2><p>Normally, <code>store.set(value)</code> synchronously calls all subscribers with <code>value</code>. However, a naive implementation will shoot you in the foot when updating a store from within a subscriber (if you think it's a wild corner case — it's not, it's how <a href="https://github.com/sveltejs/svelte/blob/64b8c8b33c52cdb1ae9ee8b0148809237c5cb997/src/runtime/store/index.ts#L187" target="_blank" rel="noopener">derived stores work</a>):</p><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> currentValue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">naiveWritable</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// let's try to avoid 0</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> store<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><br>store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=></span> currentValue <span class="token operator">=</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>If we now call <code>set(0)</code>, we intuitively expect both the store's internal value and currentValue to be <code>1</code> after all callbacks settle. But in practice it can fail:</p><ol><li>Store value becomes 0;</li><li>First subscriber sees 0, calls <code>set(1)</code>, then:<ol><li>Store value becomes 1;</li><li><code>set(1)</code> synchronously invokes all subscribers with 1;</li><li>First subscriber sees 1, does nothing;</li><li>Second subscriber is called with 1, sets <code>currentValue</code> to 1;</li><li>First subscriber run for 0 is completed, continuing with the initial updates triggered by <code>set(0)</code></li></ol></li><li>Second subscriber is called with 0, setting <code>currentValue</code> to 0;</li><li>Bang, inconsistent state!</li></ol><p>This is very dangerous territory — you're bound to either skip some values, get out-of-order updates, or have subscribers called with different values. Rich Harris has <a href="https://github.com/sveltejs/svelte/commit/a2ff93cb721b786f34e467b9bddfbf6eebcfde43" target="_blank" rel="noopener">taken a lot of effort</a> to provide the following guarantees, regardless of where you <code>set</code> the value:</p><ol><li>Every subscriber always runs for every <code>set()</code> call (corrected for primitive purity).</li><li>Subscribers for one <code>set()</code> run, uninterrupted, after one another (in insertion order, but I wouldn't rely on this too much).</li><li>Subscribers are invoked <em>globally</em> (across all svelte stores) in the same order as <code>set</code> calls, even when set calls are nested (called from within a subscriber).</li><li>All subscribers are called synchronously within the outermost <code>set</code> call (the one outside any subscriber).</li></ol><p>So, in our example, the <a href="https://svelte.dev/repl/71f93e80c07c46f896a0ee44260b5ff1?version=3.59.1" target="_blank" rel="noopener">actual callback order is:</a></p><ol><li>subscriber 1 sees 0, calls <code>set(1)</code></li><li>subscribers calls with <code>1</code> are enqueued</li><li>subscriber 2 sets <code>currentValue = 0</code></li><li>subscriber 1 runs with 1, does nothing</li><li>subscriber 2 sets <code>currentValue = 1</code></li></ol><p>Since the callback queue is global, this holds even when updating store B from a subscriber to store A. One more reason to stick with svelte built-in stores instead of rolling your own.</p><h2>Derived is lazy</h2><p><code>derived</code> looks simple on the surface — I thought it just <code>subscribe</code>s to all the stores passed, and keeps an up-to-date result of the mapper function. In reality, it's smarter than that — <a href="https://github.com/sveltejs/svelte/blob/64b8c8b33c52cdb1ae9ee8b0148809237c5cb997/src/runtime/store/index.ts#L173" target="_blank" rel="noopener">subscription and unsubscription happens in the start / stop handler,</a> which yields some nice properties:</p><ol><li>Subscriptions to base stores are automatically removed once you stop listening to the derived store, no leaks.</li><li>Derived value and subscriptions are reused no matter how many times you subscribe to a derived store.</li><li>When nobody is actively listening to a derived store, the mapper does not run.</li><li>The value is automatically updated when someone first subscribes to the derived store (again, courtesy of subscribe self-invocation).</li></ol><p>Very, very tastefully done.</p><h2>Derived is not transactional</h2><p>While lazy, <code>derived</code> is <em>not</em> transactional, and <em>not</em> batched — synchronously changing 2 dependencies will trigger 2 derivations, and 2 subscriber calls — one after the first update, and one after the second one.</p><p>In this <a href="https://svelte.dev/repl/5ad19198c21642678e70a283f8bbdfef?version=3.58.0" target="_blank" rel="noopener">code sample,</a> we'd expect <code>left + right</code> to always be 200 (we synchronously move 10 from left to right), there's a glimpse of <code>190</code> (remember, the subscribers are synchronously called during <code>set</code>):</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> left <span class="token operator">=</span> <span class="token function">writable</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> right <span class="token operator">=</span> <span class="token function">writable</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> total <span class="token operator">=</span> <span class="token function">derived</span><span class="token punctuation">(</span><span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'derive'</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>total<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'total'</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// try to preserve total = 200</span><br>    left<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">l</span> <span class="token operator">=></span> l <span class="token operator">-</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// ^^ derives, and logs "total 190"</span><br>    right<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// ^^ derives, and logs "total 200"</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>This isn't a deal breaker, svelte won't render the intermediate state, but it's something to keep in mind, or you <a href="https://svelte.dev/repl/73b0d8843045485897226cabf8efc682?version=3.58.0" target="_blank" rel="noopener">get hurt</a>:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">writable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">me</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">writable</span><span class="token punctuation">(</span><span class="token string">'me'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">derived</span><span class="token punctuation">(</span><span class="token punctuation">[</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// throws, because { me: ... } has no 'order' field</span><br>key<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'order'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>obj<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2>The mysteryous subscriber-invalidator</h2><p>Looking at <code>subscribe()</code> types, you may've noticed the <a href="https://github.com/sveltejs/svelte/blob/64b8c8b33c52cdb1ae9ee8b0148809237c5cb997/src/runtime/store/index.ts#L98" target="_blank" rel="noopener">mysterious second argument — <code>invalidate</code> callback.</a> Unlike the subscriber, it's not queued, and is always called synchronously during <code>set()</code>. The only place I've seen an invalidator used in svelte codebase is <a href="https://github.com/sveltejs/svelte/blob/64b8c8b33c52cdb1ae9ee8b0148809237c5cb997/src/runtime/store/index.ts#L202" target="_blank" rel="noopener">inside <code>derived</code></a> — and, TBH, I don't understand its purpose. I expected it to stabilize derived chains, but it's <a href="https://svelte.dev/repl/a7607d2cf8644da7aa4de1d1d2804205?version=3.59.1" target="_blank" rel="noopener">not working.</a> Also, the <a href="https://github.com/sveltejs/svelte/blob/64b8c8b33c52cdb1ae9ee8b0148809237c5cb997/src/runtime/store/index.ts#L13" target="_blank" rel="noopener">TS types are wrong</a> — the value is <a href="https://github.com/sveltejs/svelte/blob/64b8c8b33c52cdb1ae9ee8b0148809237c5cb997/src/runtime/store/index.ts#L81" target="_blank" rel="noopener">never passed</a> to invalidator as an argument. Verdict: avoid.</p><h2>$-dereference internals</h2><p>As you probably know, svelte components have a special syntax sugar for accessing stores — just prefix the store name with a <code>$</code>, and you can read and even assign it like a regular reactive variable — very convenient:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> writable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'svelte/store'</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">writable</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> $value <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>add<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token punctuation">{</span>$value<span class="token punctuation">}</span><span class="token plain-text"><br></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></code></pre><p>I always thought that <code>$value</code> is compiled to <code>get</code>, <code>$value = v</code> to <code>value.set(v)</code>, and so on, with a subscriber triggering a re-render in some smart way, but it's not the case. Instead, <code>$value</code> becomes a regular svelte reactive variable, synchronized to the store, and the rest is handled by the standard svelte update mechanism. Here's <a href="https://svelte.dev/repl/73b0d8843045485897226cabf8efc682?version=3.59.1" target="_blank" rel="noopener">the compilation result:</a></p><pre class="language-js"><code class="language-js"><span class="token comment">// the materialized $-variable</span><br><span class="token keyword">let</span> $value<span class="token punctuation">;</span><br><span class="token comment">// the store</span><br><span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">writable</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// auto-subscription</span><br><span class="token keyword">const</span> unsub <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> $value <span class="token operator">=</span> value<span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">onDestroy</span><span class="token punctuation">(</span>unsub<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// assign to variable</span><br>    $value <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>    <span class="token comment">// update store</span><br>    value<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>$value<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>In plain English:</p><ol><li><code>$store</code> is a real actual svelte reactive variable.</li><li><code>store.subscribe</code> updates the variable and triggers re-render.</li><li>The unsubscriber is stored and called <code>onDestroy</code>.</li><li>AFAIK, <code>store.update</code> is never used by svelte.</li><li>Assignments to <code>$store</code> simultaneously mutate <code>$store</code> variable <em>without</em> invalidating and triggering re-render <em>and</em> call <code>store.set</code>, which in turn enqueues the update via <code>$$invalidate</code></li></ol><p>The last point puts us in a double-source-of-truth situation: the current store value lives both in the <code>$store</code> reactive variable, and inside store itself. I expected this to cause some havok in an edge case, and so it does — if you patch <code>store.set</code> method to skip <em>some</em> updates, the $-variable updates before your custom <code>set</code> runs, and the two values <a href="https://svelte.dev/repl/50b2e2bb1a224a44ad51540e90978867?version=3.59.1" target="_blank" rel="noopener">go out of sync</a> as of svelte@3.59.1:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span><span class="token function">writable</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token comment">// prevent updates</span><br>    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> $value <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span><br><span class="token keyword">let</span> rerender <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token literal-property property">$</span><span class="token operator">:</span> total <span class="token operator">=</span> $value <span class="token operator">+</span> <span class="token punctuation">(</span>rerender <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token punctuation">{</span>total<span class="token punctuation">}</span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>add<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">increment</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> rerender <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>    rerender<br></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></code></pre><hr><p>To summarize:</p><ol><li>Both <code>readable</code> and <code>derived</code> are built on top of <code>writable</code> — readable only picks <code>subscribe</code> method, derived is a readable with a smart start / stop notifier.</li><li>Built-in stores don't rely on <code>this</code>, so you can safely use their methods as free functions.</li><li>Calling <code>subscribe(fn)</code> immediately invokes <code>fn</code> with the current value — used in <code>get(store)</code> to get the current value.</li><li>Calling <code>set()</code> with the current value of the store will skip notifying subscribers if the value is primitive. set() on object state always notifies, even if the object is same, by reference, as the current state.</li><li>The subscribers for a single <code>set()</code> run after one another. If a subscriber calls <code>set</code>, this update will be processed once the first <code>set()</code> is fully flushed.</li><li><code>derived</code> only subscribes to the base stores and maps the value when someone's actively listening to it.</li><li>When synchronously changing two dependencies of <code>derived</code>, the mapper <em>will</em> be called after the first change. There's no way to batch these updates.</li><li><code>subscribe()</code> has a second argument — a callback that's called synchronously during <code>set()</code>. I can't imagine a use case for it.</li><li><code>$store</code> syntax generates a regular svelte reactive variable called <code>$store</code>, and synchronizes it with the store in a subscriber.</li></ol><p>If you learn one thing from this article — svelte stores are thoughtfully done and help you with quite a few corner-cases. Please avoid excessive trickery, and build on top of the svelte primitives. In the next part of my svelte series, I'll show you some neat tricks with stores — <a href="https://twitter.com/thoughtspile" target="_blank" rel="noopener">stay tuned on twitter!</a></p></div><span class="share"><div><a href="https://twitter.com/share?url=https://blog.thoughtspile.tech/2023/04/22/svelte-stores/&text=Svelte stores: the curious parts by @thoughtspile" target="_blank" rel="noopener">Tweet</a></div><div id="share-button"><a>Share</a></div><div><a href="https://twitter.com/search?q=https://blog.thoughtspile.tech/2023/04/22/svelte-stores/" target="_blank" rel="noopener">Discuss on Twitter</a></div></span><div class="social-links"><a href="https://twitter.com/thoughtspile" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://mastodon.online/@thoughtspile" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg></a><a href="https://www.linkedin.com/in/vklepov/" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a href="/atom.xml" class="link--bare" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="rss" class="svg-inline--fa fa-rss fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8 0 416 186.2 416 416c0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96C14.3 96 0 81.7 0 64zM128 416c0 35.3-28.7 64-64 64s-64-28.7-64-64s28.7-64 64-64s64 28.7 64 64zM32 160c159.1 0 288 128.9 288 288c0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224c-17.7 0-32-14.3-32-32s14.3-32 32-32z"></path></svg></a></div><a href="https://buymeacoffee.com/thoughtspile" class="link--bare bmc-card" target="_blank" rel="noopener"><div><b>Hello, friend!</b> My name is Vladimir, and I love writing about web development. If you got down here, you probably enjoyed this article. My goal is to become an independent content creator, and you'll help me get there by <span class="bmc">buying me a coffee!</span></div><img src="/images/bmc.png" data-no-preview class="bmc-image"></a><div class="post-related"><div class="post-sibling"><span class="post-siblings__direction">More?</span> <a class="tag-link-link" href="/">All articles ever</a> <a class="tag-link-link" href="/tags/svelte" rel="tag">svelte</a> <a class="tag-link-link" href="/tags/programming" rel="tag">programming</a> <a class="tag-link-link" href="/tags/javascript" rel="tag">javascript</a></div><a class="link--bare post-sibling" href="/2023/04/22/svelte-state/"><span class="post-siblings__direction">Older?</span> <span class="link__text">Svelte reactivity — an inside and out guide</span> </a><a class="link--bare post-sibling" href="/2024/01/06/60-interview-lessons/"><span class="post-siblings__direction">Newer?</span> <span class="link__text">I conducted 60 interviews in 2 months — here's what I learnt</span></a></div></article><script async src="/js/share.js"></script></div></body></html>
<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="yandex-verification" content="635edef3908320be"><meta name="google-site-verification" content="5nfOA5k_QcuAP9zbAASIV24DlAZG7BWxRVYoNlKCAoc"><meta name="color-scheme" content="dark light"><meta property="og:type" content="article"><meta property="og:title" content="Svelte reactivity — an inside and out guide"><meta property="og:url" content="https://thoughtspile.github.io/2023/04/22/svelte-state/"><meta property="og:site_name" content="Vladimir Klepov as a Coder"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://thoughtspile.github.io/images/svelte-state.png?invert"><meta property="article:published_time" content="2023-04-22T00:00:00.000Z"><meta property="article:author" content="Vladimir Klepov"><meta property="article:tag" content="svelte"><meta property="article:tag" content="programming"><meta property="article:tag" content="javascript"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@thoughtspile"><meta name="twitter:image" content="https://thoughtspile.github.io/images/svelte-state.png?invert"><title>Svelte reactivity — an inside and out guide</title><link rel="stylesheet" href="/css/style.css?ts=1705836447610"><link rel="canonical" href="https://thoughtspile.github.io/2023/04/22/svelte-state/"><link rel="alternate" href="/atom.xml" title="Vladimir Klepov as a Coder" type="application/atom+xml"><script defer="defer" data-domain="thoughtspile.github.io" src="https://t.thoughtspile.tech/js/script.js"></script></head><body class="max-width mx-auto px3"><div class="content index"><a href="/" id="header" class="header header--post"><div id="logo"></div><header id="title"><h1>Vladimir Klepov as a Coder</h1></header></a><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Svelte reactivity — an inside and out guide</h1><div class="post__date">Written in <time>2023</time></div></header><div class="content" itemprop="articleBody"><p>I've been working with svelte exclusively for a year now, but I still manage to shoot myself in the foot every now and then when using reactive state. Some of the confusion is due to my prior experience with React, but some points are confusing on their own. Today, I dive into svelte internals to understand what's really going on.</p><ol><li>When you mutate svelte object state, do you really mutate the JS object?</li><li>Why doesn't <code>array.push</code> trigger an update?</li><li>How are $-dependencies determined?</li><li>Does setting a variable to its current value trigger an update?</li><li>Does a block using one object field, <code>state.field</code>, only run on changes to this field?</li><li>Why do $-variables behave a bit weirdly under JS scoping rules?</li></ol><p>We won't talk about stores too much, we still have a lot to discuss before we get there. If you're in a hurry, here's a customary cheat-sheet:</p><p><img src="/images/svelte-state.png?invert" alt=""></p><p>Let's go!</p><h2>Object state is mutable</h2><p>One thing that caught me off guard, coming from react, is that object state is mutable — the exact object defined as the initial value will stay there as long as you don't reassign the variable:</p><pre class="language-jsx"><code class="language-jsx"><span class="token comment">// data is always the same object</span><br><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token number">0</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token function-variable function">toggle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> data<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>active<span class="token punctuation">;</span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>toggle<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token punctuation">{</span>data<span class="token punctuation">.</span>active <span class="token operator">?</span> <span class="token string">'on'</span> <span class="token operator">:</span> <span class="token string">'off'</span><span class="token punctuation">}</span><span class="token plain-text"><br></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></code></pre><p>See <a href="https://svelte.dev/repl/ef02a9c7eb26402da23949ac7740f3f4?version=3.58.0" target="_blank" rel="noopener">repl.</a> By the way, this behavior also <a href="https://svelte.dev/repl/cef41b6a93494468824a2ce53cb5338e?version=3.58.0" target="_blank" rel="noopener">applies to stores.</a> This is in contrast to react, where most optimizations rely on &quot;purity&quot; — a thing is only considered changed if its reference changes.</p><p>So, svelte state is not an <em>observable object</em> built by JS means, but a regular JS variable with an <em>update event bus</em> attached separately. So far so good — the svelte way is close to how JS works. But what actually triggers the update event?</p><h2>Updates are triggered by assignment operator</h2><p>The big selling point of svelte is its concise syntax. As a <a href="https://svelte.dev/repl/758ed96027a74bd68a8e8347ed799401?version=3.58.0" target="_blank" rel="noopener">showcase example,</a> you often see what looks like simple JS, but changing the variable magically updates the component:</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">let</span> isOn <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> isOn <span class="token operator">=</span> <span class="token operator">!</span>isOn<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token punctuation">{</span>isOn <span class="token operator">?</span> <span class="token string">'on'</span> <span class="token operator">:</span> <span class="token string">'off'</span><span class="token punctuation">}</span><span class="token plain-text"><br></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></code></pre><p>The magic disappears once you get to mutable objects — calling <code>array.push()</code> or any other mutating method <a href="https://svelte.dev/repl/1b7494f2e05b490fad957931cbd3d429?version=3.58.0" target="_blank" rel="noopener">does not trigger an update:</a></p><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">function</span> <span class="token function">addItem</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token punctuation">{</span>items<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">}</span><br><span class="token operator">&lt;</span>button on<span class="token operator">:</span>click<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">addItem</span><span class="token punctuation">(</span><span class="token string">'hehe'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><br>    more<span class="token operator">!</span><br><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span></code></pre><p>This seems very familiar to react developers — of course, mutating the object does not change its reference, so further updates are skipped! To add to the confusion, react-style immutable update like <code>items = [...items, text]</code> <a href="https://svelte.dev/repl/3c710b40fec742dc88f22bb7d351459e?version=3.58.0" target="_blank" rel="noopener">fixes</a> the problem. However, svelte state is mutable, and the real issue is the lack of an assignment operator which <em>actually</em> triggers the update, so the weird self-assignment pattern <a href="https://svelte.dev/repl/4f4272b255f9475d9bb138e4b013acc2?version=3.58.0" target="_blank" rel="noopener">works just as well:</a></p><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">function</span> <span class="token function">addItem</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// #enable_magic</span><br>    items <span class="token operator">=</span> items<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Any flavor of assignment operator (<code>+=</code>, <code>++</code>, and so on) works, but it must be present for the update to happen. Another thing to note is that update logic is dynamic, not a strict &quot;if callback X runs, fire listeners to variable Y&quot; rule. The assignments are compiled to a call like <code>$$invalidate(0, items)</code>, so conditional assignment only triggers updates if it's executed:</p><pre class="language-js"><code class="language-js"><span class="token comment">// only triggers an update if text is truthy</span><br><span class="token keyword">function</span> <span class="token function">addItem</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>items<span class="token punctuation">,</span> text<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><span class="token comment">// always triggers an update</span><br><span class="token keyword">function</span> <span class="token function">addItemAlways</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    items <span class="token operator">=</span> text <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token operator">...</span>items<span class="token punctuation">,</span> text<span class="token punctuation">]</span> <span class="token operator">:</span> items<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2>Dependencies are determined statically</h2><p>Unlike invalidation, which happens dynamically at runtime, $-blocks dependencies are determined statically at compile-time. If you have some logic that <em>only</em> depends on <code>text</code> <em>if</em> <code>isTracking</code> is true...</p><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> isTracking <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br><span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><br><span class="token literal-property property">$</span><span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isTracking<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>...the block runs on every <code>text</code> change regardless of <code>isTracking</code> value, because both referenced variables, <code>text</code> and <code>isTracking</code>, are recognized as the block dependencies. This is in contrast to runtime reactivity, as seen in MobX — there's no way to even see the dependency on <code>text</code> if the code accessing it does not run.</p><p>One <em>inconvenient</em> side-effect of this dependency detection mechanism is the lack of visibility into implicit function dependencies. Say you have this code:</p><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'friend'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token function-variable function">getNonempty</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> items<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=></span> <span class="token operator">!</span><span class="token operator">!</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token literal-property property">$</span><span class="token operator">:</span> nonempty <span class="token operator">=</span> <span class="token function">getNonempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Since the $-expression defining <code>nonempty</code> does not explicitly mention <code>items</code>, it <a href="https://svelte.dev/repl/9ce86a7fc0de420d8886f509091d2620?version=3.58.0" target="_blank" rel="noopener"><em>will not</em> run</a> on <code>items</code> change. Fix: avoid functions in $-blocks, or make sure they're pure (only depend on their arguments), or (worst case) make the function itself derived: <code>$: getNonempty = ...</code></p><h2>Primitive updates are pure</h2><p>Based on the points above, you'd assume that assigning to the variable <em>always</em> triggers an update, but that's not the case. When repeatedly setting a variable to <code>true</code>, only the first change <a href="https://svelte.dev/repl/5ad19198c21642678e70a283f8bbdfef?version=3.58.0" target="_blank" rel="noopener">results in an update:</a></p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">let</span> isEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br><span class="token comment">// only run on the first click</span><br><span class="token function">afterUpdate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'updated'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token literal-property property">$</span><span class="token operator">:</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> isEnabled <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> isEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token punctuation">{</span>isEnabled <span class="token operator">?</span> <span class="token string">'clicked'</span> <span class="token operator">:</span> <span class="token string">'click me'</span><span class="token punctuation">}</span><span class="token plain-text"><br></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></code></pre><p>In general, setting a primitive variable to its current value does not trigger an update. Here's the <a href="https://svelte.dev/repl/5ad19198c21642678e70a283f8bbdfef?version=3.58.0" target="_blank" rel="noopener">svelte code</a> that implements this optimization.</p><h2>Object updates are <em>not</em> pure</h2><p>But in that case, how on earth can this support object mutation and self-assignment that don't change the object reference? Well, the trick is simple — it doesn't. Wrapping <code>isEnabled</code> with an object removes the optimization, and now the update <a href="https://svelte.dev/repl/06962949791c4e1897bbb41714d71385?version=3.58.0" target="_blank" rel="noopener">happens on every click:</a></p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">isEnabled</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token comment">// runs on every click</span><br><span class="token function">afterUpdate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'updated'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token literal-property property">$</span><span class="token operator">:</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>isEnabled<span class="token punctuation">)</span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> state<span class="token punctuation">.</span>isEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>isEnabled <span class="token operator">?</span> <span class="token string">'clicked'</span> <span class="token operator">:</span> <span class="token string">'click me'</span><span class="token punctuation">}</span><span class="token plain-text"><br></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></code></pre><p>The <a href="https://github.com/sveltejs/svelte/blob/6ba2f722518b3fb6904d6d566c3c1a00d61fe70a/src/runtime/internal/utils.ts#L41" target="_blank" rel="noopener">code implementing the comparison</a> always says &quot;it's changed&quot; when it sees an object.</p><h2>Reactivity is variable-grained</h2><p>As we've just seen, object state is always treated as a whole — there is no <em>field-level reactivity.</em> If you have an $-block that only depends on a single field of the object, it <a href="https://svelte.dev/repl/689900fc527b41a79ed9e9efba9c93ed?version=3.58.0" target="_blank" rel="noopener">will run on <em>any</em> change to the object:</a></p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> fields <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">clicks</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">''</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token comment">// runs on every "clicks" change</span><br><span class="token literal-property property">$</span><span class="token operator">:</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fields<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> fields<span class="token punctuation">.</span>clicks<span class="token operator">++</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>    clicks: </span><span class="token punctuation">{</span>fields<span class="token punctuation">.</span>clicks<span class="token punctuation">}</span><span class="token plain-text"><br></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name"><span class="token namespace">bind:</span>value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>fields<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span></code></pre><p>If we only want the $-block to run on actual <code>name</code> change, we can achieve that by extracting <code>name</code> to a separate reactive variable. This variable will have its own &quot;change event&quot;, independent of other object fields. In our example it's better to just define the fields as separate variables from the start, but in general this can be done <a href="https://svelte.dev/repl/a69f93746691429f8581cb16510a59ed?version=3.58.0" target="_blank" rel="noopener">using a <em>$-variable:</em></a></p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> fields <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">clicks</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">''</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token comment">// uses primitive comparison under the hood:</span><br><span class="token literal-property property">$</span><span class="token operator">:</span> name <span class="token operator">=</span> fields<span class="token punctuation">.</span>name<br><span class="token comment">// runs on "name" change only</span><br><span class="token literal-property property">$</span><span class="token operator">:</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> fields<span class="token punctuation">.</span>clicks<span class="token operator">++</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>    clicks: </span><span class="token punctuation">{</span>fields<span class="token punctuation">.</span>clicks<span class="token punctuation">}</span><span class="token plain-text"><br></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name"><span class="token namespace">bind:</span>value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>fields<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span></code></pre><p>Note that object-to-object mapping does not optimize anything and just <a href="https://svelte.dev/repl/515680f84f8642108f8678a9f1bbfe29?version=3.58.0" target="_blank" rel="noopener">runs on every dependency change.</a> This is because the &quot;pure&quot; optimization is only applied when all dependencies are primitive (computation is not triggered), or the output is primitive (further dependencies are not triggered).</p><h2>$-variables are an illusion</h2><p>If you've spent some time moving $-variables around, you know they behave weirdly from JS scoping perspective:</p><ol><li>You can reference the &quot;scope&quot; variables (declared with let / const) declared <em>after</em> the $-expression (in normal JS, this is TDZ)</li><li>You can access $-variable anywhere in the script, but the value outside $-blocks is <code>undefined</code></li></ol><p>Here's an example to illustrate this behavior:</p><pre class="language-js"><code class="language-js"><span class="token comment">// you can reference variables before they're declared</span><br><span class="token literal-property property">$</span><span class="token operator">:</span> name <span class="token operator">=</span> state<span class="token punctuation">.</span>name<span class="token punctuation">;</span><br><span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">''</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token comment">// logs "undefined"</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The trick is, again, simple — $-variables are just sugar over a simple let declaration and an $-block that assigns to the variable. The variable declaration is hoisted to the top (which is funny, because this perfectly emulates a <code>var</code> declaration), and $-blocks become callbacks defined <em>after</em> the synchronous initialization code. The un-sugared equivalent of the code above will be:</p><pre class="language-js"><code class="language-js"><span class="token comment">// hoisted let declaration</span><br><span class="token keyword">let</span> name<span class="token punctuation">;</span><br><span class="token comment">// init block</span><br><span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">''</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// $-blocks</span><br><span class="token literal-property property">$</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    name <span class="token operator">=</span> state<span class="token punctuation">.</span>name<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>If you want to go one level down, the output in both cases is:</p><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> name<span class="token punctuation">;</span><br><span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>$$self<span class="token punctuation">.</span>$$<span class="token punctuation">.</span><span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>$$self<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>dirty <span class="token operator">&amp;</span> <span class="token comment">/*state*/</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// you can reference variables before they're declared</span><br>        <span class="token literal-property property">$</span><span class="token operator">:</span> name <span class="token operator">=</span> state<span class="token punctuation">.</span>name<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>One funny side effect of this is that you can <em>assign</em> to the $-variable from e.g. another $-block, or a callback. The variable is not strongly bound to its definition, the last assignment wins. This would be quite confusing, though, and I recommend against such trickery.</p><hr><p>To summarize, here's the result of my research:</p><ol><li>Svelte object state is truly mutable. &quot;Reactive variables&quot; are just regular JS variables with change event bus attached as a sidecar.</li><li>Updates are only triggered by assigning to reactive variables — assignment is compiled to <code>$$invalidate(var_index, value)</code> call.</li><li>Reactive block dependencies are determined at compile-time based on variables used inside the block.</li><li>&quot;Pure&quot; optimization only applies to primitive values.</li><li>Variable is the smallest unit of reactivity — changing a single object field triggers all the blocks using this object.</li><li>$-variables are compiled to a hoisted let declaration and a callback called after the setup code.</li></ol><p>Hope you've learnt something useful today — I sure have. Next time, we'll dissect svelte stores — <a href="https://twitter.com/thoughtspile" target="_blank" rel="noopener">follow me on twitter</a> to stay updated!</p></div><span class="share"><div><a href="https://twitter.com/share?url=https://thoughtspile.github.io/2023/04/22/svelte-state/&text=Svelte reactivity — an inside and out guide by @thoughtspile" target="_blank" rel="noopener">Tweet</a></div><div id="share-button"><a>Share</a></div><div><a href="https://twitter.com/search?q=https://thoughtspile.github.io/2023/04/22/svelte-state/" target="_blank" rel="noopener">Discuss on Twitter</a></div></span><div class="social-links"><a href="https://twitter.com/thoughtspile" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://mastodon.online/@thoughtspile" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg></a><a href="https://www.linkedin.com/in/vklepov/" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a href="/atom.xml" class="link--bare" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="rss" class="svg-inline--fa fa-rss fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8 0 416 186.2 416 416c0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96C14.3 96 0 81.7 0 64zM128 416c0 35.3-28.7 64-64 64s-64-28.7-64-64s28.7-64 64-64s64 28.7 64 64zM32 160c159.1 0 288 128.9 288 288c0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224c-17.7 0-32-14.3-32-32s14.3-32 32-32z"></path></svg></a></div><a href="https://buymeacoffee.com/thoughtspile" class="link--bare bmc-card" target="_blank" rel="noopener"><div><b>Hello, friend!</b> My name is Vladimir, and I love writing about web development. If you got down here, you probably enjoyed this article. My goal is to become an independent content creator, and you'll help me get there by <span class="bmc">buying me a coffee!</span></div><img src="/images/bmc.png" data-no-preview class="bmc-image"></a><div class="post-related"><div class="post-sibling"><span class="post-siblings__direction">More?</span> <a class="tag-link-link" href="/">All articles ever</a> <a class="tag-link-link" href="/tags/svelte" rel="tag">svelte</a> <a class="tag-link-link" href="/tags/programming" rel="tag">programming</a> <a class="tag-link-link" href="/tags/javascript" rel="tag">javascript</a></div><a class="link--bare post-sibling" href="/2023/03/02/banditypes-smallest-validation/"><span class="post-siblings__direction">Older?</span> <span class="link__text">How I made banditypes, the smallest TS validation library</span> </a><a class="link--bare post-sibling" href="/2023/04/22/svelte-stores/"><span class="post-siblings__direction">Newer?</span> <span class="link__text">Svelte stores: the curious parts</span></a></div></article><script async src="/js/share.js"></script></div></body></html>
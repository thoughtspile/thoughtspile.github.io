<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="yandex-verification" content="635edef3908320be"><meta name="google-site-verification" content="5nfOA5k_QcuAP9zbAASIV24DlAZG7BWxRVYoNlKCAoc"><meta name="color-scheme" content="dark light"><meta property="og:type" content="article"><meta property="og:title" content="How I made banditypes, the smallest TS validation library"><meta property="og:url" content="https://thoughtspile.github.io/2023/03/02/banditypes-smallest-validation/"><meta property="og:site_name" content="Vladimir Klepov as a Coder"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://thoughtspile.github.io/images/banditypes-sample.png"><meta property="article:published_time" content="2023-03-02T00:00:00.000Z"><meta property="article:author" content="Vladimir Klepov"><meta property="article:tag" content="javascript"><meta property="article:tag" content="typescript"><meta property="article:tag" content="open source"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@thoughtspile"><meta name="twitter:image" content="https://thoughtspile.github.io/images/banditypes-sample.png"><title>How I made banditypes, the smallest TS validation library</title><link rel="stylesheet" href="/css/style.css?ts=1705836447582"><link rel="canonical" href="https://thoughtspile.github.io/2023/03/02/banditypes-smallest-validation/"><link rel="alternate" href="/atom.xml" title="Vladimir Klepov as a Coder" type="application/atom+xml"><script defer="defer" data-domain="thoughtspile.github.io" src="https://t.thoughtspile.tech/js/script.js"></script></head><body class="max-width mx-auto px3"><div class="content index"><a href="/" id="header" class="header header--post"><div id="logo"></div><header id="title"><h1>Vladimir Klepov as a Coder</h1></header></a><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">How I made banditypes, the smallest TS validation library</h1><div class="post__date">Written in <time>2023</time></div></header><div class="content" itemprop="articleBody"><p>I open-sourced <a href="https://github.com/thoughtspile/banditypes" target="_blank" rel="noopener">banditypes</a> — the smallest runtime validation library for TS / JS. It manages to fit all the basic functionality into an astounding 400 bytes. For reference, the popular <a href="https://zod.dev/" target="_blank" rel="noopener">zod</a> and <a href="https://github.com/jquense/yup" target="_blank" rel="noopener">yup</a> libraries are around 11KB, <a href="https://github.com/ianstormtaylor/superstruct" target="_blank" rel="noopener">superstruct</a> measures 1.8KB for the same set of functionality.</p><p><img src="/images/banditypes-sample.png" alt=""></p><p>Today, I'll tell you how I managed to pull this off. The article is divided into three parts. First, we discuss the downsides of traditional bundle size measurement techniques, and come up with a more realistic way to assess it. Then I explain the design process focused on minimizing bundle size — with this alone, the size clocked around 500 bytes. Finally, I share the extra optimizations and dirty hacks that allowed me to strip off another 20% and arrive at the current 385-byte size.</p><p><em>This article originally appeared <a href="https://habr.com/ru/company/ruvds/blog/719708/" target="_blank" rel="noopener">in Russian</a> on habr.com</em></p><h2>Size measurement technique</h2><p>When people say that &quot;library X is 40 kilobytes&quot;, they usually mean that the full build (usually UMD) of the library, minified and gzipped, is 40 kilobytes. This was perfect back in 2008, when you dropped the jQuery script from an obscure CDN onto your website; it was bearable in 2015 when <code>require</code> instead of copy-pasting code was enough to make us happy. But in 2023, with static imports end ES modules and stuff, this is just not a realistic measure (albeit a simple one to measure).</p><p>First off, we have tree shaking, and it's pretty good if you don't stand in its way. If a library is a collection of 200 utilities, of which I only use one, I don't really care about the total size of all helpers, as long as only one makes it into my bundle. Judging libraries by full size not only punishes feature-rich libraries (you're not strong, you're FAT, ha-ha), but also fails to assess the tree-shakability of the library. Besides, the standalone library bundle includes full exported names, like <code>export enums</code> or, while in real life the names will be <a href="https://terser.org/docs/api-reference#mangle-options" target="_blank" rel="noopener">mangled</a> or even completely eliminated by inlining the functions into the call site.</p><p>Tools like <a href="https://bundlejs.com/" target="_blank" rel="noopener">bundlejs.com</a> and <a href="https://github.com/ai/size-limit" target="_blank" rel="noopener">size-limit</a> bundle a small sample app importing from your library, taking care of these problems. But classical single-pass analysis still contains some <em>artifacts</em> that skew the measurement, and for <em>tiny</em> libraries this interference can make the majority of the reported bundle size:</p><ul><li>Repetitions of common JS syntax — <code>const</code>, <code>function(</code>, <code>for (let</code> etc. Every client app most likely contains these already, so, thanks to gzip, a library gets them almost for free.</li><li>Wrappers and runtime generated by the bundler — it can be as small as an IIFE wrapper, but it's still there.</li><li>22 bytes of gzip service data called &quot;End Of Central Directory record&quot;. Again, as long as your library is bundled together with the user code, this is not added to the bundle a second time.</li></ul><p>To address all of these issues, I build two versions of a small sample app. The first one, baseline, contains just a small chunk of JS relevant to the use case — an object we're validating, and some try / catch blocks. The second one adds banditype validation on top of that. The size difference of the bundles generated is the <em>real</em> size cost added by banditypes — not accounting for stuff that's already there (it's 218 bytes BTW), <em>but</em> including the user-defined schema. This last point is very important – otherwise, you can achieve an illusion of a smaller library by making the <em>user</em> type more code. Mental experiment: &quot;I published a hot new 0-byte UI framework! Install it with npm i zerro and build UI using vanilla DOM API manually&quot;.</p><p>This approach also lets me measure the size with different subsets of functionality and assess the quality of tree shaking. 385 bytes is the size of a full build, while the common core (object, array, and primitives) sits at 207 bytes, and the &quot;core&quot; with no validations is 96 bytes. Different minifiers can be plugged in to cover the variety of real-world use cases: I report the 5-pass terser size as it's the most established minifier that you <em>should</em> use if bundle size is a concern, but esduild minifier is not far behind at 405 bytes.</p><h2>Design for smolness</h2><p>If you start the development by randomly slapping the keyboard until you let out all the functionality you could think of, and <em>then</em> try to also make it small, you're probably up for an unpleasant failure. Instead, small size should be at the core of your design decisions from the outset:</p><ol><li>Design for tree-shaking. Why is <a href="https://zod.dev/" target="_blank" rel="noopener">zod</a> around 11KB no matter how few of its functions you use, while <a href="https://github.com/ianstormtaylor/superstruct" target="_blank" rel="noopener">superstruct</a> achieves a very respectable 1.8KB size for a real-world use case, with the same feature set? Because zod heavily relies on methods: <code>z.number().gt(5)</code>, while superstruct uses functional composition: <code>min(number(), 9000)</code>. The minifier can take a look at the bundle, see that function <code>max</code> is not referenced, and remove it. But finding all the places where zod's number validator is used, analyze its methods and drop the unused ones is nearly impossible. Besides, function names are much easier and safer to mangle. So, we should rely on functions as much as possible.</li><li>Focused feature set. A major feature of decent validation libraries is returning detailed error messaged describing what, exactly, did not pass the validation: <code>{ message: 'Expected string, got number', path: ['item', 'title'] }</code>. I'm sure this is a useful feature, but I also know it's not needed in <em>every</em> use case, so I decided to remove this functionality. Besides, fewer features mean quicker development.</li><li>More extensibility. To cut functionality <em>without</em> putting the users and ourselves into an unpleasant position when some critical stuff is missing, we need to let the users extend the library. I added two methods (yes, methods, more on that in a minute) to every validator:</li></ol><ul><li><code>type1.map(res =&gt; ...)</code> — perform extra validation aka type refinement: <code>string().map(str =&gt; str.length ? str : fail())</code> or transform the data: <code>string().map(str =&gt; [str])</code></li><li><code>type1.or(val =&gt; ...)</code> — If the left validation fails, try the right one. It's obviously useful for union types: <code>string().or(optional()))</code>, but also works for default values: <code>string().or(() =&gt; 'default')</code></li></ul><ol start="4"><li>While we're at it, it's really great if we can make <em>one</em> thing perform several roles. <code>map</code> can both refine and transform the data, <code>or</code> works as a union or a default value.</li></ol><p>I think the resulting API is quite beautiful — and compatible with the established libraries to facilitate migration:</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> userSchema <span class="token operator">=</span> <span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  title<span class="token operator">:</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token comment">// refinement</span><br>  price<span class="token operator">:</span> <span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>num <span class="token operator">=></span> num <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> num <span class="token operator">:</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  tags<span class="token operator">:</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token function">enums</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'sale'</span><span class="token punctuation">,</span> <span class="token string">'liked'</span><span class="token punctuation">,</span> <span class="token string">'sold'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// string OR a string array</span><br><span class="token keyword">const</span> strings <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// data conversion</span><br><span class="token keyword">const</span> arraySum <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>arr <span class="token operator">=></span> arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>acc<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">=></span> acc <span class="token operator">+</span> e<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2>Optimizations</h2><p>Smolness as a design principle already gives us a very neat 520-byte size. But I did not just want a small library, I wanted the smallest library possible. So, it's time to try like hell and push for sub-400 without sacrificing too much DX.</p><ol><li>Compile to modern JS. Replacing <code>function array(raw) ...</code> with <code>const array = (raw) =&gt; ...</code>, and using raw spreads, surprisingly, saved 23 bytes. gzip is pretty good at removing repetition (the uncompressed bundle was reduced by 430 bytes), but there still is something to be gained. ES2017 is reasonably well supported by browsers, and you can transpile the library further down yourself.</li><li>Remove duplicate APIs. Why have a <code>literal(42)</code> type if you can model it like a single-value union, <code>enums([42])</code>? It's not that single literal is a common type to validate, anyways.</li><li>Repetition is power. Gzip is great at removing repetition. If you have arrow functions, turn <em>all</em> functions into arrow functions, so that there is more repetition. If you already use a word <code>Object</code>, you can use it again, almost for free. If <em>every</em> function accepts a single argument, it makes for a nice <code>=(e)=&gt;{</code> repeating chunk (terser makes all argument names the same). Surprisingly, having a function copy-pasted with a minor change is smaller, under gzip, than reusing a &quot;proper&quot; parametrized base function.</li><li><code>typeof x === 'number'</code> can be replaced with instance-based check: <code>like = sample =&gt; raw =&gt; typeof raw == typeof sample</code>, and then you define <code>number</code> type as <code>like(0)</code>. 20 bytes!</li><li><code>throw new TypeError('Invalid Banditype')</code> is quite a big chunk of code. We can just call a string: <code>'bad banditype'()</code>, and the error will be thrown anyways. 20 bytes!</li></ol><p>Naturally, I tried out a ton of ideas that didn't work. Replacing <code>throw</code> with <code>return null</code> did slim down the size a bit, <em>but</em> forced the code to rely on optional chaining, which is not well-supported, and validating container types became much harder, because the errors don't magically bubble up anymore, not to mention the problems with validating real <code>null</code> values. I also expected to gain something by replacing <code>for..in</code> with <code>Object.keys</code>, because it's an expression, and expressions minify better, but it didn't work at all.</p><p>Finally, I left <code>map / or</code> as methods, even though I could strip 17 bytes by modeling them as pure functions. They are <em>not</em> likely to be tree-shaken completely (this would trigger a 50-byte reduction), because built-in <code>object</code> and <code>array</code> validations use <code>map</code> internally, and <code>or</code> is used for optional and nullable types. Besides, I much prefer the readability of the chained version: <code>string().map(s =&gt; [s]).or(array(string()))</code> reads like a normal sentence, while <code>or(map(string(), s =&gt; [s]), array(string))</code> is some weird mashup of words.</p><hr><p>Today we took a first look at a new validation library, <a href="https://github.com/thoughtspile/banditypes" target="_blank" rel="noopener">banditypes.</a> I managed to fit some useful, non-trivial functionality into a measly 400 bytes by treating small size as a core design principle:</p><ul><li>Prefer functions over methods, because they minify better.</li><li>Cut features aggressively. Extra validations and detailed error messages are not useful in <em>every</em> scenario, so they had to go.</li><li>Make the library extensible to compensate for the limited feature set.</li><li>Be resourceful, and provide multi-purpose tools.</li></ul><p>And applying some more optimizations on top of that:</p><ul><li>Modern JS = less code.</li><li>Remove duplicate APIs. One way to do something is enough.</li><li>Repetitive code is good code, as far as gzip is concerned.</li><li><code>typeof raw === typeof sample</code> trick</li><li><code>'bad banditype'()</code> hack instead of an explicit throw</li></ul><p>I think banditypes really shines in some use cases — try it out in your apps! I'd also really appreciate you <a href="https://github.com/thoughtspile/banditypes" target="_blank" rel="noopener">starring the repo</a> on github — it means a lot!</p></div><span class="share"><div><a href="https://twitter.com/share?url=https://thoughtspile.github.io/2023/03/02/banditypes-smallest-validation/&text=How I made banditypes, the smallest TS validation library by @thoughtspile" target="_blank" rel="noopener">Tweet</a></div><div id="share-button"><a>Share</a></div><div><a href="https://twitter.com/search?q=https://thoughtspile.github.io/2023/03/02/banditypes-smallest-validation/" target="_blank" rel="noopener">Discuss on Twitter</a></div></span><div class="social-links"><a href="https://twitter.com/thoughtspile" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://mastodon.online/@thoughtspile" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg></a><a href="https://www.linkedin.com/in/vklepov/" class="link--bare" target="_blank" rel="noopener"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a href="/atom.xml" class="link--bare" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="rss" class="svg-inline--fa fa-rss fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8 0 416 186.2 416 416c0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96C14.3 96 0 81.7 0 64zM128 416c0 35.3-28.7 64-64 64s-64-28.7-64-64s28.7-64 64-64s64 28.7 64 64zM32 160c159.1 0 288 128.9 288 288c0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224c-17.7 0-32-14.3-32-32s14.3-32 32-32z"></path></svg></a></div><a href="https://buymeacoffee.com/thoughtspile" class="link--bare bmc-card" target="_blank" rel="noopener"><div><b>Hello, friend!</b> My name is Vladimir, and I love writing about web development. If you got down here, you probably enjoyed this article. My goal is to become an independent content creator, and you'll help me get there by <span class="bmc">buying me a coffee!</span></div><img src="/images/bmc.png" data-no-preview class="bmc-image"></a><div class="post-related"><div class="post-sibling"><span class="post-siblings__direction">More?</span> <a class="tag-link-link" href="/">All articles ever</a> <a class="tag-link-link" href="/tags/javascript" rel="tag">javascript</a> <a class="tag-link-link" href="/tags/typescript" rel="tag">typescript</a> <a class="tag-link-link" href="/tags/open source" rel="tag">open source</a></div><a class="link--bare post-sibling" href="/2023/02/12/open-source-analytics/"><span class="post-siblings__direction">Older?</span> <span class="link__text">Ditch google analytics now: 7 open-source alternatives</span> </a><a class="link--bare post-sibling" href="/2023/04/22/svelte-state/"><span class="post-siblings__direction">Newer?</span> <span class="link__text">Svelte reactivity — an inside and out guide</span></a></div></article><script async src="/js/share.js"></script></div></body></html>